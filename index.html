<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ºåŒ—å¸‚æ”¿åºœæ¶ˆé˜²å±€ 114å¹´æ•™è‚²è¨“ç·´ç®¡ç†ç³»çµ± (æ——è‰¦å®Œæ•´ç‰ˆ)</title>
    
    <!-- 1. ExcelJS (æ¨£å¼åŒ¯å‡ºæ ¸å¿ƒ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <!-- 2. FileSaver (æª”æ¡ˆå„²å­˜è¼”åŠ©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- 3. PapaParse (CSV è§£ææ ¸å¿ƒ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        :root { --bg: #f1f5f9; --sidebar: #1e293b; --accent: #3b82f6; --header: #f8fafc; --border: #cbd5e1; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; height: 100vh; margin: 0; overflow: hidden; color: #333; }
        
        /* Loading é®ç½© */
        #loading { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: none; justify-content: center; align-items: center; color: white; flex-direction: column; font-size: 18px; backdrop-filter: blur(4px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Layout */
        .sidebar { width: 240px; background: var(--sidebar); color: white; display: flex; flex-direction: column; }
        .sb-header { padding: 20px; background: #0f172a; border-bottom: 1px solid #334155; }
        .sb-item { padding: 15px 20px; cursor: pointer; color: #94a3b8; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .sb-item:hover, .sb-item.active { background: #334155; color: white; }
        .sb-item.active { color: var(--accent); border-left: 4px solid var(--accent); font-weight: bold; }
        
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .topbar { height: 55px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .ws { flex: 1; padding: 20px; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Table View */
        .view { display: none; height: 100%; flex-direction: column; background: white; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .view.active { display: flex; }
        .t-container { flex: 1; overflow: auto; }
        
        table { border-collapse: collapse; font-size: 13px; table-layout: fixed; width: 100%; }
        th { background: var(--header); color: #475569; border: 1px solid #94a3b8; padding: 4px; position: sticky; top: 0; z-index: 10; height: 50px; }
        td { border: 1px solid #cbd5e1; height: 36px; background: white; padding: 0; position: relative; }
        
        /* Input & Controls */
        input[type="text"], input[type="number"] { width: 100%; height: 100%; border: none; background: transparent; text-align: center; outline: none; font-family: inherit; }
        input:focus { background: #eff6ff; box-shadow: inset 0 0 0 2px var(--accent); }
        .align-left input { text-align: left; padding-left: 5px; }
        
        .date-box { display: flex; height: 100%; }
        .date-box input { flex: 1; }
        .btn-cal { width: 30px; background: #f1f5f9; border: none; border-left: 1px solid #cbd5e1; cursor: pointer; }
        .btn-cal:hover { background: #e2e8f0; }

        /* Checkbox (ä»¿ Excel) */
        .chk-cell { text-align: center; vertical-align: middle; }
        .ex-chk { appearance: none; width: 18px; height: 18px; border: 1px solid #333; background: white; cursor: pointer; display: inline-block; vertical-align: middle; }
        .ex-chk:checked::after { content: 'âœ“'; font-weight: 900; color: #000; display: block; text-align: center; line-height: 16px; }

        /* Gantt Chart */
        .gantt-m-row td { background: #e2e8f0; font-weight: bold; text-align: left; padding-left: 15px; border-top: 2px solid #475569; color: #1e293b; }
        .gantt-vis-row { height: 14px; }
        .gantt-bar { border-right: 1px solid #e2e8f0; }
        .bar-on { background: var(--accent) !important; border-color: #2563eb; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .gantt-num input { font-weight: bold; color: #0f172a; }
        .stat-row td { background: #f1f5f9; color: #1e40af; font-weight: bold; text-align: center; border-top: 2px double #94a3b8; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 420px; padding: 20px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin: 15px 0; }
        .day-btn { padding: 8px; border: 1px solid #cbd5e1; text-align: center; cursor: pointer; border-radius: 4px; }
        .day-btn.active { background: #dbeafe; color: #1e40af; border-color: var(--accent); font-weight: bold; }
        .day-btn.excluded { background: #64748b; color: white; text-decoration: line-through; opacity: 0.8; }
        .day-btn.disabled { background: #f8fafc; color: #ccc; cursor: default; }
        .quick-actions { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .btn-q { padding: 5px 10px; font-size: 12px; border: 1px solid #cbd5e1; background: white; cursor: pointer; border-radius: 4px; }
        .btn-q:hover { background: #f1f5f9; }

        /* Buttons & Colors */
        .btn { padding: 6px 14px; border-radius: 4px; border: none; color: white; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px; margin-left: 8px; }
        .btn-add { width: 100%; padding: 10px; background: white; border: 1px dashed #94a3b8; color: var(--accent); font-weight: bold; cursor: pointer; }
        .bg-y { background: #ffffcc !important; -webkit-print-color-adjust: exact; } 
        .bg-b { background: #e0f2fe !important; -webkit-print-color-adjust: exact; }
        .bg-r { background: #fee2e2 !important; -webkit-print-color-adjust: exact; }
        
        /* Print (A3 Landscape Force Zoom) */
        @media print {
            @page { size: A3 landscape; margin: 5mm; }
            body { transform: scale(0.85); transform-origin: top left; width: 115%; } /* å¼·åˆ¶ç¸®æ”¾ä»¥å¡å…¥ A3 */
            .sidebar, .topbar button, .btn-add, .del-btn, .btn-cal { display: none !important; }
            .view { display: none; border: none; box-shadow: none; }
            .view.active { display: block; }
            table { width: 100%; }
            th, td { border: 1px solid #000 !important; color: black !important; }
        }
    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div><div id="loadText">è¼‰å…¥ä¸­...</div></div>

    <!-- Date Modal -->
    <div id="dateModal" class="modal">
        <div class="modal-box">
            <h3 style="margin:0 0 10px 0">æ’é™¤æ—¥æœŸè¨­å®š</h3>
            <div id="modalRange" style="color:var(--accent); font-size:13px; margin-bottom:10px;"></div>
            <div class="quick-actions">
                <button class="btn-q" onclick="applyQuickFilter('all')">å…¨é¸ (ä¸æ’é™¤)</button>
                <button class="btn-q" onclick="applyQuickFilter('no-weekend')">æ’é™¤å…­æ—¥</button>
                <button class="btn-q" onclick="applyQuickFilter('only-weekend')">åƒ…é¸å…­æ—¥</button>
                <button class="btn-q" onclick="applyQuickFilter('clear')">æ¸…é™¤ (å…¨æ’é™¤)</button>
            </div>
            <div class="cal-grid" id="calGrid"></div>
            <div style="text-align:right; margin-top:15px;">
                <button class="btn" style="background:#cbd5e1; color:#333; display:inline-block;" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn" style="background:var(--accent); display:inline-block;" onclick="saveModal()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sb-header"><h2>è¨“ç·´æµè·¯ç³»çµ±</h2><span style="font-size:11px;color:#64748b">v4.0 æœ€çµ‚ç‰ˆ</span></div>
        <div class="sb-item active" onclick="switchTab(1,this)">1. æ¶ˆé˜²äººå“¡</div>
        <div class="sb-item" onclick="switchTab(2,this)">2. éæ¶ˆé˜²äººå“¡</div>
        <div class="sb-item" onclick="switchTab(3,this)">3. é‡å¤§æ´»å‹•</div>
        <div class="sb-item" onclick="switchTab(4,this)">4. ç”˜ç‰¹åœ–</div>
    </div>

    <div class="main">
        <div class="topbar">
            <h3 id="pageTitle" style="margin:0">é™„ä»¶1 - æ¶ˆé˜²äººå“¡</h3>
            <div style="display:flex; align-items:center;">
                <span id="status" style="font-size:12px; color:#64748b; margin-right:10px;"></span>
                <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="processCSV(this)">
                <button class="btn" style="background:#64748b" onclick="document.getElementById('csvInput').click()">ğŸ“‚ åŒ¯å…¥ CSV</button>
                <button class="btn" style="background:#0f172a" onclick="saveData()">â˜ï¸ å„²å­˜è³‡æ–™</button>
                <button class="btn" style="background:#16a34a" onclick="exportExcelJS()">ğŸ“¥ ä¸‹è¼‰ Excel</button>
                <button class="btn" style="background:#dc2626" onclick="window.print()">ğŸ–¨ï¸ åˆ—å° PDF</button>
            </div>
        </div>

        <div class="ws">
            <!-- Tab 1 -->
            <div id="v1" class="view active"><div class="t-container"><table id="t1"><thead>
                <tr><th style="width:40px">åˆª</th><th style="width:40px">é …</th><th style="width:40px">æœˆ</th><th style="width:100px">å–®ä½</th><th style="width:200px">èª²ç¨‹åç¨±</th><th style="width:80px">å°è±¡</th><th style="width:140px">æ—¥æœŸ (1/6-19)</th><th style="width:120px">åœ°é»</th><th style="width:40px">æ¢¯</th><th style="width:50px">æ¯æ¢¯äºº</th><th style="width:50px">åˆè¨ˆ</th><th style="width:50px">æ—¥å®‰</th><th style="width:50px">æ¢¯æ™‚</th><th style="width:50px">ç¸½æ™‚</th><th style="width:80px" class="bg-b">èª¿ç”¨</th><th style="width:100px" class="bg-y">æä¾›å¤–ç¸£å¸‚</th><th style="width:50px" class="bg-y">æ–°åŒ—</th><th style="width:50px" class="bg-y">åŸºéš†</th><th style="width:50px" class="bg-y">æ¡ƒåœ’</th><th style="width:50px" class="bg-y">å®œè˜­</th><th style="width:150px">å‚™è¨»</th></tr>
            </thead><tbody id="tb1"></tbody></table></div><button class="btn-add" onclick="addRow(1)">+ æ–°å¢</button></div>

            <!-- Tab 2 -->
            <div id="v2" class="view"><div class="t-container"><table id="t2"><thead>
                <tr><th style="width:40px">åˆª</th><th style="width:40px">åº</th><th style="width:40px">æœˆ</th><th style="width:100px">å–®ä½</th><th style="width:200px">èª²ç¨‹åç¨±</th><th style="width:100px">å°è±¡</th><th style="width:140px">æ—¥æœŸ</th><th style="width:120px">åœ°é»</th><th style="width:40px">æ¢¯</th><th style="width:50px">æ¯æ¢¯äºº</th><th style="width:50px">åˆè¨ˆ</th><th style="width:50px">æ—¥å®‰</th><th style="width:50px">æ¢¯æ™‚</th><th style="width:50px">ç¸½æ™‚</th><th style="width:80px">æ•™å®˜</th><th style="width:80px">è·¨ç¸£å¸‚</th><th style="width:150px">å‚™è¨»</th></tr>
            </thead><tbody id="tb2"></tbody></table></div><button class="btn-add" onclick="addRow(2)">+ æ–°å¢</button></div>

            <!-- Tab 3 -->
            <div id="v3" class="view"><div class="t-container"><table id="t3"><thead>
                <tr><th style="width:40px">åˆª</th><th style="width:40px">åº</th><th style="width:100px">å–®ä½</th><th style="width:250px">æ´»å‹•åç¨±</th><th style="width:150px">å°è±¡</th><th style="width:140px">æ—¥æœŸ</th><th style="width:50px">å¤©æ•¸</th><th style="width:50px">æ™‚æ•¸</th><th style="width:80px" class="bg-r">èª¿ç”¨</th><th style="width:150px">åœ°é»</th></tr>
            </thead><tbody id="tb3"></tbody></table></div><button class="btn-add" onclick="addRow(3)">+ æ–°å¢</button></div>

            <!-- Tab 4 -->
            <div id="v4" class="view"><div class="t-container"><table id="t4"><thead><tr id="ganttHead"><th style="width:250px">ç­æœŸ / æ´»å‹•åç¨±</th></tr></thead><tbody id="tb4"></tbody></table></div></div>
        </div>
    </div>

    <script>
        // =================================================
        // âš ï¸ ç¶²å€è¨­å®šå€
        const API_URL = "https://script.google.com/macros/s/AKfycbxB06TURmbo4QW7ecb5OprxEF3mnJGve_Qkq64qvcyKTS0d4__4kmpzxFvJ9T6Cw0jKuQ/exec"; 
        // =================================================

        let d1=[], d2=[], d3=[];
        let currentTab = 1;

        window.onload = loadData;

        function switchTab(idx, el) {
            document.querySelectorAll('.sb-item').forEach(i=>i.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
            document.getElementById(`v${idx}`).classList.add('active');
            currentTab = idx;
            const titles=["é™„ä»¶1 - æ¶ˆé˜²äººå“¡","é™„ä»¶2 - éæ¶ˆé˜²äººå“¡","é™„ä»¶3 - é‡å¤§æ´»å‹•","ç”˜ç‰¹åœ– - è¨“ç·´æµè·¯"];
            document.getElementById('pageTitle').innerText = titles[idx-1];
            if(idx===4) renderGantt();
        }

        // --- Data Logic ---
        function loadData() {
            if(API_URL.includes("è«‹è²¼ä¸Š")) {
                // é è¨­ç©ºè³‡æ–™ (é›¢ç·šæ¸¬è©¦ç”¨)
                d1 = [{m:'1', unit:'è¨“ç·´ä¸­å¿ƒ', name:'æ¸¬è©¦èª²ç¨‹', date:'1/6-19', mp:20, ex:[], isNew:true}]; 
                renderAll();
                return;
            }
            toggleLoad(true, "é›²ç«¯åŒæ­¥ä¸­...");
            fetch(API_URL)
                .then(r=>r.json())
                .then(res => {
                    if(res.status === 'success') {
                        // Mapping back from array
                        d1 = (res.d1||[]).map(r=>({m:r[0], unit:r[1], name:r[2], target:r[3], date:r[4], loc:r[5], batch:r[6], pb:r[7], dh:r[9], bh:r[10], mp:r[12], ext:r[13]==='true', nt:r[14], kl:r[15], ty:r[16], yl:r[17], note:r[18], ex:JSON.parse(r[19]||'[]'), isNew:false}));
                        d2 = (res.d2||[]).map(r=>({m:r[0], unit:r[1], name:r[2], target:r[3], date:r[4], loc:r[5], batch:r[6], pb:r[7], dh:r[9], bh:r[10], inst:r[12], ext:r[13]==='true', note:r[14], ex:JSON.parse(r[15]||'[]'), isNew:false}));
                        d3 = (res.d3||[]).map(r=>({unit:r[0], name:r[1], target:r[2], date:r[3], days:r[4], hours:r[5], mp:r[6], loc:r[7], ex:JSON.parse(r[8]||'[]'), isNew:false}));
                        renderAll();
                        document.getElementById('status').innerText = "å·²åŒæ­¥";
                    }
                })
                .catch(e=>alert("è®€å–éŒ¯èª¤:"+e))
                .finally(()=>toggleLoad(false));
        }

        function saveData() {
            if(API_URL.includes("è«‹è²¼ä¸Š")) return alert("è«‹è¨­å®š API URL");
            toggleLoad(true, "å¯«å…¥è³‡æ–™åº«...");
            
            const p1 = d1.map(r=>[r.m,r.unit,r.name,r.target,r.date,r.loc,r.batch,r.pb,(r.batch*r.pb)||0,r.dh,r.bh,(r.batch*r.bh)||0,r.mp,r.ext,r.nt,r.kl,r.ty,r.yl,r.note,JSON.stringify(r.ex)]);
            const p2 = d2.map(r=>[r.m,r.unit,r.name,r.target,r.date,r.loc,r.batch,r.pb,(r.batch*r.pb)||0,r.dh,r.bh,(r.batch*r.bh)||0,r.inst,r.ext,r.note,JSON.stringify(r.ex)]);
            const p3 = d3.map(r=>[r.unit,r.name,r.target,r.date,r.days,r.hours,r.mp,r.loc,JSON.stringify(r.ex)]);

            fetch(API_URL, { method:'POST', body:JSON.stringify({d1:p1, d2:p2, d3:p3}), headers:{'Content-Type':'text/plain'} })
                .then(r=>r.json())
                .then(res => {
                    if(res.status==='success') {
                        alert(res.message);
                        // Save success, mark all as not new
                        [d1,d2,d3].forEach(d => d.forEach(r => r.isNew = false));
                        renderAll();
                    } else alert("å„²å­˜å¤±æ•—:"+res.message);
                })
                .finally(()=>toggleLoad(false));
        }

        function toggleLoad(show, txt) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
            if(txt) document.getElementById('loadText').innerText = txt;
        }

        // --- Render Logic ---
        function renderAll() { renderT1(); renderT2(); renderT3(); }

        function renderT1() {
            const tb = document.getElementById('tb1'); tb.innerHTML='';
            d1.forEach((r,i)=> {
                tb.innerHTML += `<tr>
                    <td style="text-align:center"><button class="del-btn" onclick="del(1,${i})" style="border:none;background:none;color:#94a3b8;cursor:pointer;">âœ•</button></td>
                    <td><input type="text" value="${i+1}" readonly style="color:#999"></td>
                    <td><input type="text" value="${r.m||''}" onchange="d1[${i}].m=this.value"></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d1[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d1[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d1[${i}].target=this.value"></td>
                    <td><div class="date-box"><input type="text" value="${r.date||''}" onchange="d1[${i}].date=this.value" placeholder="1/6-19"><button class="btn-cal" onclick="openModal(1,${i})">ğŸ“…</button></div></td>
                    <td><input type="text" value="${r.loc||''}" onchange="d1[${i}].loc=this.value"></td>
                    <td><input type="number" value="${r.batch||''}" onchange="d1[${i}].batch=this.value"></td>
                    <td><input type="number" value="${r.pb||''}" onchange="d1[${i}].pb=this.value"></td>
                    <td style="background:#f1f5f9;text-align:center;line-height:36px">${(r.batch*r.pb)||0}</td>
                    <td><input type="number" value="${r.dh||''}" onchange="d1[${i}].dh=this.value"></td>
                    <td><input type="number" value="${r.bh||''}" onchange="d1[${i}].bh=this.value"></td>
                    <td style="background:#f1f5f9;text-align:center;line-height:36px">${(r.batch*r.bh)||0}</td>
                    <td class="bg-b"><input type="number" value="${r.mp||''}" onchange="d1[${i}].mp=this.value" style="color:#1e40af;font-weight:bold"></td>
                    <td class="bg-y chk-cell"><input type="checkbox" class="ex-chk" ${r.ext?'checked':''} onchange="d1[${i}].ext=this.checked"></td>
                    <td class="bg-y"><input type="number" value="${r.nt||''}" onchange="d1[${i}].nt=this.value"></td>
                    <td class="bg-y"><input type="number" value="${r.kl||''}" onchange="d1[${i}].kl=this.value"></td>
                    <td class="bg-y"><input type="number" value="${r.ty||''}" onchange="d1[${i}].ty=this.value"></td>
                    <td class="bg-y"><input type="number" value="${r.yl||''}" onchange="d1[${i}].yl=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.note||''}" onchange="d1[${i}].note=this.value"></td>
                </tr>`;
            });
        }
        function renderT2() {
            const tb = document.getElementById('tb2'); tb.innerHTML='';
            d2.forEach((r,i)=> {
                tb.innerHTML += `<tr>
                    <td style="text-align:center"><button class="del-btn" onclick="del(2,${i})" style="border:none;background:none;color:#94a3b8;cursor:pointer;">âœ•</button></td>
                    <td><input type="text" value="${i+1}" readonly style="color:#999"></td>
                    <td><input type="text" value="${r.m||''}" onchange="d2[${i}].m=this.value"></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d2[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d2[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d2[${i}].target=this.value"></td>
                    <td><div class="date-box"><input type="text" value="${r.date||''}" onchange="d2[${i}].date=this.value"><button class="btn-cal" onclick="openModal(2,${i})">ğŸ“…</button></div></td>
                    <td><input type="text" value="${r.loc||''}" onchange="d2[${i}].loc=this.value"></td>
                    <td><input type="number" value="${r.batch||''}" onchange="d2[${i}].batch=this.value"></td>
                    <td><input type="number" value="${r.pb||''}" onchange="d2[${i}].pb=this.value"></td>
                    <td style="background:#f1f5f9;text-align:center;line-height:36px">${(r.batch*r.pb)||0}</td>
                    <td><input type="number" value="${r.dh||''}" onchange="d2[${i}].dh=this.value"></td>
                    <td><input type="number" value="${r.bh||''}" onchange="d2[${i}].bh=this.value"></td>
                    <td style="background:#f1f5f9;text-align:center;line-height:36px">${(r.batch*r.bh)||0}</td>
                    <td><input type="number" value="${r.inst||''}" onchange="d2[${i}].inst=this.value"></td>
                    <td class="chk-cell"><input type="checkbox" class="ex-chk" ${r.ext?'checked':''} onchange="d2[${i}].ext=this.checked"></td>
                    <td class="align-left"><input type="text" value="${r.note||''}" onchange="d2[${i}].note=this.value"></td>
                </tr>`;
            });
        }
        function renderT3() {
            const tb = document.getElementById('tb3'); tb.innerHTML='';
            d3.forEach((r,i)=> {
                tb.innerHTML += `<tr>
                    <td style="text-align:center"><button class="del-btn" onclick="del(3,${i})" style="border:none;background:none;color:#94a3b8;cursor:pointer;">âœ•</button></td>
                    <td><input type="text" value="${i+1}" readonly style="color:#999"></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d3[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d3[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d3[${i}].target=this.value"></td>
                    <td><div class="date-box"><input type="text" value="${r.date||''}" onchange="d3[${i}].date=this.value"><button class="btn-cal" onclick="openModal(3,${i})">ğŸ“…</button></div></td>
                    <td><input type="number" value="${r.days||''}" onchange="d3[${i}].days=this.value"></td>
                    <td><input type="number" value="${r.hours||''}" onchange="d3[${i}].hours=this.value"></td>
                    <td class="bg-r"><input type="number" value="${r.mp||''}" onchange="d3[${i}].mp=this.value" style="color:#b91c1c;font-weight:bold"></td>
                    <td class="align-left"><input type="text" value="${r.loc||''}" onchange="d3[${i}].loc=this.value"></td>
                </tr>`;
            });
        }

        // --- Gantt Logic ---
        function renderGantt() {
            const head = document.getElementById('ganttHead');
            head.innerHTML = '<th style="width:250px">ç­æœŸ / æ´»å‹•åç¨±</th>';
            for(let i=1;i<=31;i++) head.innerHTML+=`<th style="width:30px;font-size:11px;color:#64748b;">${i}</th>`;
            const tb = document.getElementById('tb4'); tb.innerHTML='';

            let rows=[];
            d1.forEach(r=>{if(r.date&&r.mp)rows.push({m:r.m||'1',n:r.name,ds:getDays(r),v:r.mp});});
            d2.forEach(r=>{if(r.date&&r.inst)rows.push({m:r.m||'1',n:r.name,ds:getDays(r),v:r.inst});});
            d3.forEach(r=>{if(r.date&&r.mp){let m=r.date.match(/^(\d+)/);rows.push({m:m?m[1]:'1',n:r.name,ds:getDays(r),v:r.mp});}});

            let grp={};
            for(let i=1;i<=12;i++) grp[i]=[];
            rows.forEach(r=>{if(grp[r.m])grp[r.m].push(r)});

            for(let m=1;m<=12;m++){
                if(grp[m].length===0) continue;
                tb.innerHTML += `<tr class="gantt-m-row"><td colspan="32">${m} æœˆä»½</td></tr>`;
                let sum=Array(32).fill(0);
                grp[m].forEach(r=>{
                    let vis=`<tr class="gantt-vis-row"><td style="border-right:1px solid #e2e8f0"></td>`;
                    let dat=`<tr class="gantt-data-row"><td class="align-left" style="padding-left:10px;font-size:12px;">${r.n}</td>`;
                    for(let i=1;i<=31;i++){
                        let act=r.ds.includes(i);
                        if(act) sum[i]+=parseInt(r.v);
                        vis+=`<td class="gantt-bar ${act?'bar-on':''}"></td>`;
                        dat+=`<td class="gantt-num">${act?`<input type="text" value="${r.v}" readonly>`:''}</td>`;
                    }
                    tb.innerHTML += vis+'</tr>'+dat+'</tr>';
                });
                let sRow=`<tr class="stat-row"><td>æ¯æ—¥çµ±è¨ˆ</td>`;
                for(let i=1;i<=31;i++) sRow+=`<td>${sum[i]>0?sum[i]:''}</td>`;
                tb.innerHTML += sRow+'</tr>';
            }
        }

        function getDays(r) {
            let days=[]; if(!r.date) return days;
            try {
                let s=r.date.replace(/\(.*\)/g,'').trim();
                let rng=s.match(/(\d+)\/(\d+)-(\d+)/), sgl=s.match(/(\d+)\/(\d+)/);
                let temp=[];
                if(rng) for(let i=+rng[2];i<=+rng[3];i++) temp.push(i);
                else if(sgl) temp.push(+sgl[2]);
                else if(s.includes(',')) s.split(',').forEach(p=>{let m=p.match(/\d+$/);if(m)temp.push(+m[0])});
                
                // Filter Excluded
                days = temp.filter(d => !(r.ex||[]).includes(d));
            } catch(e){}
            return days;
        }

        // --- Modal Logic ---
        let curEdit=null;
        function openModal(t,i) {
            curEdit={t,i};
            let r=(t==1?d1:t==2?d2:d3)[i];
            let temp=getDays({...r,ex:[]}); // Get ALL days in range
            if(temp.length==0) return alert('è«‹å…ˆè¼¸å…¥æ­£ç¢ºæ—¥æœŸ (å¦‚ 1/6-19)');
            document.getElementById('modalRange').innerText = `ç›®å‰ç¯„åœ: ${temp.join(', ')} (å…±${temp.length}å¤©)`;
            
            let grid=document.getElementById('calGrid'); grid.innerHTML='';
            for(let d=1; d<=31; d++){
                let btn=document.createElement('div');
                btn.className='day-btn'; btn.innerText=d;
                if(temp.includes(d)) {
                    btn.classList.add('active');
                    if((r.ex||[]).includes(d)) btn.classList.add('excluded');
                    btn.onclick = ()=> btn.classList.toggle('excluded');
                } else btn.classList.add('disabled');
                grid.appendChild(btn);
            }
            document.getElementById('dateModal').style.display='flex';
        }
        function closeModal() { document.getElementById('dateModal').style.display='none'; }
        
        function saveModal() {
            let ex = Array.from(document.querySelectorAll('.day-btn.active.excluded')).map(b=>parseInt(b.innerText));
            let {t,i} = curEdit;
            (t==1?d1:t==2?d2:d3)[i].ex = ex;
            closeModal(); renderAll();
        }

        function applyQuickFilter(type) {
            let btns = document.querySelectorAll('.day-btn.active');
            btns.forEach(b => {
                let d = parseInt(b.innerText);
                // ç°¡æ˜“é‚è¼¯ï¼šå‡è¨­èª²ç¨‹åœ¨ 2025 å¹´æŸæœˆ (æœªå®šæœˆä»½å‰‡ç„¡æ³•ç²¾æº–åˆ¤æ–·æ˜ŸæœŸ)
                // é€™è£¡æˆ‘å€‘å‡è¨­ d å°±æ˜¯æ—¥æœŸï¼Œæˆ‘å€‘åªèƒ½å¤§æ¦‚æ¨ç®—å¦‚æœçŸ¥é“æœˆä»½ã€‚
                // ç‚ºæ±‚é€šç”¨ï¼Œé€™è£¡å…ˆç”¨ã€Œä½ç½®ã€åšæ¨¡æ“¬ï¼Œæˆ–è€…ç°¡å–®å…¨é¸/å…¨ä¸é¸
                // é€²éšï¼šæˆ‘å€‘éœ€è¦çŸ¥é“ç¾åœ¨æ˜¯å¹¾æœˆã€‚å¾ row è£¡æ‹¿ã€‚
                let row = (curEdit.t==1?d1:curEdit.t==2?d2:d3)[curEdit.i];
                let month = row.m ? parseInt(row.m) : 1; 
                let date = new Date(2025, month-1, d);
                let day = date.getDay(); // 0=Sun, 6=Sat

                if(type==='all') b.classList.remove('excluded');
                if(type==='clear') b.classList.add('excluded');
                if(type==='no-weekend') {
                    if(day===0 || day===6) b.classList.add('excluded');
                    else b.classList.remove('excluded');
                }
                if(type==='only-weekend') {
                    if(day===0 || day===6) b.classList.remove('excluded');
                    else b.classList.add('excluded');
                }
            });
        }

        // --- Delete Logic ---
        function del(t, i) {
            let row = (t==1?d1:t==2?d2:d3)[i];
            if(row.isNew) {
                // New row, free delete
                (t==1?d1:t==2?d2:d3).splice(i,1);
                renderAll();
            } else {
                // Saved row, password required
                let pass = prompt("åˆªé™¤å·²å­˜æª”è³‡æ–™ï¼Œè«‹è¼¸å…¥å¯†ç¢¼ (119):");
                if(pass === "119") {
                    (t==1?d1:t==2?d2:d3).splice(i,1);
                    renderAll();
                } else if(pass !== null) {
                    alert("å¯†ç¢¼éŒ¯èª¤");
                }
            }
        }
        
        function addRow(t) {
            let newRow = {isNew:true, ex:[], date:'', name:''}; 
            if(t==1) d1.push({...newRow, m:'', mp:0});
            if(t==2) d2.push({...newRow, m:'', inst:0});
            if(t==3) d3.push({...newRow, unit:'', mp:0});
            renderAll();
        }

        // --- CSV Import ---
        function processCSV(input) {
            const file = input.files[0];
            if(!file) return;
            
            Papa.parse(file, {
                complete: function(results) {
                    // ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœæ¬„ä½å¾ˆå¤šä¸Ÿ d1ï¼Œå°‘ä¸€é»ä¸Ÿ d3
                    // å¯¦å‹™ä¸Šå»ºè­°ä¸‹è¼‰å°ˆç”¨ç¯„æœ¬
                    let rows = results.data;
                    if(rows.length < 2) return alert("CSV ç©ºç™½æˆ–æ ¼å¼éŒ¯èª¤");
                    
                    // å‡è¨­ä½¿ç”¨è€…åŒ¯å…¥çš„æ˜¯ç¬¦åˆæ ¼å¼çš„è³‡æ–™ï¼Œç›´æ¥ append åˆ°ç›®å‰çš„ Tab
                    // é€™è£¡åšä¸€å€‹ç°¡å–®çš„ mapping (å‡è¨­ CSV é †åºè·Ÿæ¬„ä½ä¸€æ¨£)
                    let target = currentTab==1?d1 : currentTab==2?d2 : d3;
                    
                    rows.forEach((r, idx) => {
                        if(idx===0) return; // Skip header
                        if(r.length < 3) return;
                        
                        // å»ºç«‹æ–°ç‰©ä»¶
                        let newObj = { isNew:true, ex:[] };
                        if(currentTab==1) {
                            newObj.m=r[1]; newObj.unit=r[2]; newObj.name=r[3]; newObj.target=r[4]; 
                            newObj.date=r[5]; newObj.mp=r[13];
                        } else if(currentTab==2) {
                            newObj.m=r[1]; newObj.unit=r[2]; newObj.name=r[3]; newObj.date=r[5];
                        } // ...
                        
                        target.push(newObj);
                    });
                    renderAll();
                    alert(`æˆåŠŸåŒ¯å…¥ ${rows.length-1} ç­†è³‡æ–™ï¼è«‹è¨˜å¾—æŒ‰å„²å­˜ã€‚`);
                }
            });
            input.value = ''; // reset
        }

        // --- ExcelJS Export (High Fidelity) ---
        async function exportExcelJS() {
            const wb = new ExcelJS.Workbook();
            
            // Helper for styles
            const headerStyle = (cell, color) => {
                cell.fill = { type:'pattern', pattern:'solid', fgColor:{argb: color} };
                cell.border = { top:{style:'thin'}, left:{style:'thin'}, bottom:{style:'thin'}, right:{style:'thin'} };
                cell.alignment = { vertical:'middle', horizontal:'center', wrapText:true };
                cell.font = { bold:true };
            };
            const cellStyle = (cell) => {
                cell.border = { top:{style:'thin'}, left:{style:'thin'}, bottom:{style:'thin'}, right:{style:'thin'} };
                cell.alignment = { vertical:'middle', horizontal:'center' };
            };

            // --- Sheet 1 ---
            const s1 = wb.addWorksheet('é™„ä»¶1-æ¶ˆé˜²äººå“¡');
            const h1 = ["é …æ¬¡","æœˆä»½","æ‰¿è¾¦å–®ä½","èª²ç¨‹åç¨±","è¨“ç·´å°è±¡","èª²ç¨‹æ—¥æœŸ","ä¸Šèª²åœ°é»","æ¢¯æ•¸","æ¯æ¢¯äººæ•¸","åˆè¨ˆäººæ•¸","æ¯å¤©æ™‚æ•¸","æ¯æ¢¯æ™‚æ•¸","åˆè¨ˆæ™‚æ•¸","é è¨ˆèª¿ç”¨äººæ•¸","æ˜¯å¦æä¾›å®œåŸºåŒ—æ¡ƒåƒè¨“","æš«è¨‚æ–°åŒ—","æš«è¨‚åŸºéš†","æš«è¨‚æ¡ƒåœ’","æš«è¨‚å®œè˜­","å‚™è¨»"];
            const r1 = s1.addRow(h1);
            r1.height = 40;
            r1.eachCell((c, col) => {
                let color = 'F8FAFC'; // Gray
                if(col===14) color = 'E0F2FE'; // Blue
                if(col>=15 && col<=19) color = 'FFFFCC'; // Yellow
                headerStyle(c, color);
            });
            
            d1.forEach((d, i) => {
                const row = s1.addRow([
                    i+1, d.m, d.unit, d.name, d.target, d.date, d.loc, d.batch, d.pb, (d.batch*d.pb)||0,
                    d.dh, d.bh, (d.batch*d.bh)||0, d.mp, d.ext?'V':'', d.nt, d.kl, d.ty, d.yl, d.note
                ]);
                row.eachCell(c => cellStyle(c));
            });
            s1.columns.forEach(c => { c.width = 12; }); // èª¿æ•´æ¬„å¯¬
            s1.getColumn(4).width = 25; // èª²ç¨‹åç¨±å¯¬ä¸€é»

            // --- Sheet 2 ---
            const s2 = wb.addWorksheet('é™„ä»¶2-éæ¶ˆé˜²');
            const h2 = ["åºè™Ÿ","æœˆä»½","æ‰¿è¾¦å–®ä½","èª²ç¨‹åç¨±","è¨“ç·´å°è±¡","èª²ç¨‹æ—¥æœŸ","è¨“ç·´åœ°é»","æ¢¯æ•¸","æ¯æ¢¯äººæ•¸","åˆè¨ˆäººæ•¸","æ¯å¤©æ™‚æ•¸","æ¯æ¢¯æ™‚æ•¸","åˆè¨ˆæ™‚æ•¸","èª¿ç”¨æ•™å®˜äººæ•¸","æ˜¯å¦æä¾›è·¨ç¸£å¸‚","å‚™è¨»"];
            const r2 = s2.addRow(h2);
            r2.eachCell(c => headerStyle(c, 'F8FAFC'));
            d2.forEach((d, i) => {
                const row = s2.addRow([
                    i+1, d.m, d.unit, d.name, d.target, d.date, d.loc, d.batch, d.pb, (d.batch*d.pb)||0,
                    d.dh, d.bh, (d.batch*d.bh)||0, d.inst, d.ext?'V':'', d.note
                ]);
                row.eachCell(c => cellStyle(c));
            });

            // --- Sheet 3 ---
            const s3 = wb.addWorksheet('é™„ä»¶3-é‡å¤§æ´»å‹•');
            const h3 = ["åºè™Ÿ","æ‰¿è¾¦å–®ä½","é‡å¤§æ´»å‹•åç¨±","åƒåŠ å°è±¡","æ—¥æœŸ","å¤©æ•¸","æ™‚æ•¸","æ¯æ—¥èª¿ç”¨å¤–å‹¤äººæ•¸","åœ°é»"];
            const r3 = s3.addRow(h3);
            r3.eachCell((c, col) => headerStyle(c, col===8 ? 'FEE2E2' : 'F8FAFC')); // Red for manpower
            d3.forEach((d, i) => {
                const row = s3.addRow([i+1, d.unit, d.name, d.target, d.date, d.days, d.hours, d.mp, d.loc]);
                row.eachCell(c => cellStyle(c));
            });

            // --- Download ---
            const buf = await wb.xlsx.writeBuffer();
            saveAs(new Blob([buf]), "114å¹´æ¶ˆé˜²è¨“ç·´æµè·¯ç¸½è¡¨.xlsx");
        }

    </script>
</body>
</html>
