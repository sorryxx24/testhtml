<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>訓練流路管理系統 (UI優化版)</title>

    <!-- 核心工具庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- 視覺框架 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script>
        // ==========================================
        // ⚠️ 1. 系統連結
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwqsvGTpqNdMrzCZ46GwyPrkHFjU53PfJlgMRPB4G7avoRDGiIml6BoP_2uZY4QJ7dz/exec";

        // ⚠️ 2. 系統整合連結
        const PORTAL_URL = "https://sorryxx24.github.io/Linktest/";
        const OTHER_SYSTEM_URL = "https://sorryxx24.github.io/Facility-Booking-Test/";
        // ==========================================
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* 更淡的背景色 */
        }

        /* 側邊欄樣式優化 */
        .sidebar-link {
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .sidebar-link:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .sidebar-link.active {
            background-color: rgba(37, 99, 235, 0.2);
            color: #93c5fd;
            border-left: 3px solid #3b82f6;
        }

        /* 表格容器優化 */
        .table-container {
            overflow-x: auto;
            background: #fff;
            border-radius: 0 0 8px 8px; /* 上方由 Header 接管圓角 */
            border: 1px solid #e2e8f0;
            border-top: none;
        }

        /* 表格壓縮樣式 */
        table {
            border-collapse: collapse;
            font-size: 12px; /* 字體縮小一點 */
            table-layout: fixed;
            width: auto;
            border-spacing: 0;
        }

        #table1 { min-width: 2000px; }
        #table2 { min-width: 1800px; }
        
        /* 表頭壓縮 */
        th {
            background: #f1f5f9;
            color: #475569;
            font-weight: 700;
            border: 1px solid #cbd5e1;
            position: sticky;
            top: 0;
            z-index: 10;
            height: 36px; /* 高度壓縮 */
            padding: 2px 4px;
            box-sizing: border-box;
            white-space: nowrap;
        }

        td {
            border: 1px solid #cbd5e1;
            height: auto;
            min-height: 32px; /* 儲存格高度壓縮 */
            background: white;
            position: relative;
            box-sizing: border-box;
            padding: 0;
            vertical-align: middle;
        }

        /* 輸入框壓縮 */
        input[type="text"], input[type="number"] {
            width: 100%;
            height: 32px; /* 輸入框高度壓縮 */
            border: none;
            outline: none;
            background: transparent;
            text-align: center;
            font-family: inherit;
            font-size: 12px;
            display: block;
            color: #334155;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            background: #eff6ff;
            box-shadow: inset 0 0 0 2px #3b82f6;
        }

        textarea {
            width: 100%;
            min-height: 32px;
            height: 100%;
            border: none;
            resize: none;
            outline: none;
            background: transparent;
            font-family: inherit;
            font-size: 12px;
            text-align: left;
            padding: 4px 8px;
            box-sizing: border-box;
            white-space: pre-wrap;
            overflow: hidden;
            display: block;
            line-height: 1.3;
        }
        textarea:focus { background: #eff6ff; box-shadow: inset 0 0 0 2px #3b82f6; }

        /* 甘特圖相關 */
        #table4 {
            width: 1232px !important;
            min-width: 1232px !important;
            max-width: 1232px !important;
            table-layout: fixed !important;
            border-collapse: collapse;
            margin: 0;
        }
        .col-fix-name { width: 300px !important; padding: 4px !important; font-size: 12px; }
        .col-fix-day { width: 30px !important; padding: 0 !important; font-size: 11px; }
        .gantt-visual-row, .gantt-data-row { height: 24px; line-height: 24px; } /* 甘特圖也壓縮 */
        .gantt-cell-bar { height: 24px; border-bottom: none; }
        .gantt-num { height: 24px; line-height: 24px; border-top: none; }
        
        .weekend { background-color: #f3f4f6; }
        .bar-active { background-color: #3b82f6 !important; border-color: #000; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        
        /* UI 元件 */
        .date-cell { display: flex; align-items: center; height: 100%; }
        .btn-calendar {
            width: 24px; height: 100%; min-height: 32px; border: none; border-left: 1px solid #cbd5e1;
            cursor: pointer; background: #f8fafc; color: #64748b; transition: 0.2s;
        }
        .btn-calendar:hover { background: #e2e8f0; color: #3b82f6; }
        .col-yellow { background: #ffffcc !important; }
        .col-blue-light { background: #e0f2fe !important; }
        .col-red-light { background: #fee2e2 !important; }

        /* Modal & Loading */
        #loading { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 9999; display: none; justify-content: center; align-items: center; color: white; flex-direction: column; font-size: 16px; backdrop-filter: blur(4px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin: 10px 0; }
        .day-btn { padding: 6px; border: 1px solid #e2e8f0; background: white; cursor: pointer; text-align: center; border-radius: 4px; font-size: 13px; }
        .day-btn.active.excluded { background: #64748b; color: white; text-decoration: line-through; border-color: #475569; }
        .day-btn.active { background: #dbeafe; color: #1e40af; font-weight: bold; border-color: #3b82f6; }
        
        .print-month-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
        .month-select-btn { padding: 8px; border: 1px solid #e2e8f0; background: white; cursor: pointer; text-align: center; border-radius: 6px; font-weight: bold; transition: 0.2s; font-size: 13px; }
        .month-select-btn:hover { background: #f1f5f9; }
        .month-select-btn.selected { background: #3b82f6; color: white; border-color: #2563eb; }

        /* 列印設定 */
        @media print {
            @page { size: A3 landscape; margin: 5mm; }
            body { background: white; height: auto; overflow: visible; display: block !important; }
            #sidebar, .top-bar, .mobile-header, #loading, #control-panel, .divider-section, .btn-action-area { display: none !important; }
            .view-section { display: none; margin: 0; padding: 0; }
            .view-section.active { display: block; }
            .table-container { border: none; overflow: visible; width: 100%; }
            /* 針對列印的寬度鎖定 */
            #table4 { width: 1232px !important; }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex selection:bg-blue-500 selection:text-white">

    <div id="loading">
        <div class="spinner"></div>
        <div id="loadText">處理中...</div>
    </div>

    <!-- Date Modal -->
    <div id="dateModal" class="fixed inset-0 bg-black/50 hidden z-[2000] justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-[90%] max-w-[400px] p-5 rounded-xl shadow-2xl">
            <h3 class="font-bold text-base mb-2 text-slate-800">排除日期設定</h3>
            <div id="modalRangeText" class="text-xs text-blue-600 mb-2 font-mono"></div>
            <div class="flex flex-wrap gap-2 mb-3">
                <button class="px-2 py-1 text-xs font-bold border rounded hover:bg-slate-100" onclick="applyDateFilter('all')">全選</button>
                <button class="px-2 py-1 text-xs font-bold border rounded hover:bg-slate-100" onclick="applyDateFilter('no-weekend')">排除六日</button>
                <button class="px-2 py-1 text-xs font-bold border rounded hover:bg-slate-100" onclick="applyDateFilter('only-weekend')">僅選六日</button>
                <button class="px-2 py-1 text-xs font-bold border rounded hover:bg-slate-100 text-red-500" onclick="applyDateFilter('clear')">清除</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
            <div class="flex justify-end gap-2 mt-4">
                <button class="px-4 py-1.5 text-xs text-slate-500 hover:bg-slate-100 rounded-lg font-bold" onclick="closeModal('dateModal')">取消</button>
                <button class="px-4 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md" onclick="saveDateModal()">確定</button>
            </div>
        </div>
    </div>

    <!-- Print Modal -->
    <div id="printModal" class="fixed inset-0 bg-black/50 hidden z-[2000] justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-[90%] max-w-[400px] p-5 rounded-xl shadow-2xl">
            <h3 class="font-bold text-base mb-2 text-slate-800">輸出月份選擇</h3>
            <div class="flex justify-between items-center mb-3">
                <span class="text-xs text-slate-500">選擇要匯出的月份</span>
                <button class="px-2 py-1 text-xs border rounded hover:bg-slate-50" onclick="toggleAllMonths()">全選/反選</button>
            </div>
            <div class="print-month-grid" id="printMonthGrid"></div>
            <div class="flex justify-end gap-2 mt-4">
                <button class="px-4 py-1.5 text-slate-500 hover:bg-slate-100 rounded-lg font-bold" onclick="closeModal('printModal')">取消</button>
                <button class="px-4 py-1.5 bg-slate-900 text-white rounded-lg hover:bg-slate-800 font-bold shadow-md" onclick="executePrintOrExport()">執行</button>
            </div>
        </div>
    </div>

    <!-- 側邊欄 (更新版：多元宇宙連結) -->
    <aside id="sidebar" class="w-64 bg-slate-900 text-white hidden md:flex flex-col shadow-2xl z-30 relative">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/50">
                <i class="ri-flow-chart text-white text-lg"></i>
            </div>
            <div>
                <h1 class="font-bold text-base tracking-wide">訓練流路</h1>
                <p class="text-[10px] text-slate-400">內部管理系統</p>
            </div>
        </div>

        <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
            <div onclick="switchTab(1, this)" class="sidebar-link active cursor-pointer w-full text-left px-4 py-3 rounded-lg flex items-center gap-3">
                <i class="ri-user-fire-line text-lg"></i> <span class="text-sm font-medium">消防人員</span>
            </div>
            <div onclick="switchTab(2, this)" class="sidebar-link cursor-pointer w-full text-left px-4 py-3 rounded-lg text-slate-400 flex items-center gap-3">
                <i class="ri-group-line text-lg"></i> <span class="text-sm font-medium">非消防人員</span>
            </div>
            <div onclick="switchTab(3, this)" class="sidebar-link cursor-pointer w-full text-left px-4 py-3 rounded-lg text-slate-400 flex items-center gap-3">
                <i class="ri-flag-line text-lg"></i> <span class="text-sm font-medium">重大活動</span>
            </div>
            <div onclick="switchTab(4, this)" class="sidebar-link cursor-pointer w-full text-left px-4 py-3 rounded-lg text-slate-400 flex items-center gap-3">
                <i class="ri-bar-chart-horizontal-line text-lg"></i> <span class="text-sm font-medium">甘特圖預覽</span>
            </div>
        </nav>

        <!-- 訓練系統多元宇宙 (參考連結區) -->
        <div class="p-4 border-t border-slate-800 bg-slate-900">
            <div class="text-[10px] text-slate-500 font-bold mb-2 uppercase tracking-wider pl-1">訓練系統多元宇宙</div>
            <div class="space-y-1">
                <a href="javascript:void(0)" onclick="location.href=PORTAL_URL" class="block px-3 py-2 rounded text-slate-400 hover:text-white hover:bg-slate-800 transition text-xs flex items-center gap-2">
                    <i class="ri-apps-2-line"></i> 訓練管理整合平台
                </a>
                <a href="javascript:void(0)" onclick="location.href=OTHER_SYSTEM_URL" class="block px-3 py-2 rounded text-slate-400 hover:text-white hover:bg-slate-800 transition text-xs flex items-center gap-2">
                    <i class="ri-building-2-line"></i> 場地借用系統
                </a>
                <a href="https://www.tfd.gov.tw" target="_blank" class="block px-3 py-2 rounded text-slate-400 hover:text-white hover:bg-slate-800 transition text-xs flex items-center gap-2">
                    <i class="ri-government-line"></i> 消防局入口網
                </a>
            </div>
        </div>
    </aside>

    <!-- 主內容區 -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-50">

        <!-- 手機版 Header -->
        <div class="mobile-header bg-white md:hidden h-14 flex items-center justify-between px-4 shadow-sm border-b border-slate-200 z-20">
            <div class="flex items-center gap-3">
                <button onclick="toggleMobileSidebar()" class="text-slate-600 p-2"><i class="ri-menu-line text-xl"></i></button>
                <div class="font-bold text-slate-800 text-sm" id="mobilePageTitle">消防人員</div>
            </div>
        </div>

        <!-- 內容捲動區 -->
        <div class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth">
            
            <!-- 上層：控制面板 (模擬填報確認區塊樣式) -->
            <div id="control-panel" class="bg-white rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-yellow-400 p-5 mb-6">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div>
                        <h2 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <i class="ri-settings-4-line text-yellow-500 text-lg"></i>
                            全域功能操作
                        </h2>
                        <p class="text-xs text-slate-400 mt-1">匯入資料、儲存雲端或下載範本</p>
                    </div>
                    <div class="flex items-center gap-2" id="global-actions">
                        <!-- 按鈕會透過 JS 動態注入這裡 -->
                    </div>
                </div>
            </div>

            <!-- 分隔線 (視覺區隔) -->
            <div class="divider-section flex items-center gap-4 mb-6 opacity-60">
                <div class="h-px bg-slate-300 flex-1 border-t border-dashed border-slate-300"></div>
                <div class="text-slate-400 text-[10px] font-mono tracking-widest uppercase">Data Entry Workspace</div>
                <div class="h-px bg-slate-300 flex-1 border-t border-dashed border-slate-300"></div>
            </div>

            <!-- 下層：新增作業區 (資料表格) -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-blue-600 flex flex-col h-[calc(100%-180px)] min-h-[400px]">
                
                <!-- 表格標題列 -->
                <div class="px-5 py-3 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-xl">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center text-blue-600">
                            <i class="ri-edit-box-line"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-sm" id="table-card-title">新增作業區</h3>
                            <p class="text-[10px] text-slate-400">請在下方表格編輯資料</p>
                        </div>
                    </div>
                    <!-- 針對甘特圖的特定按鈕區 -->
                    <div id="gantt-actions" class="hidden flex gap-2"></div>
                </div>

                <!-- 表格內容區 -->
                <div class="relative flex-1 overflow-hidden">
                    <!-- VIEW 1: 消防人員 -->
                    <div id="view1" class="view-section h-full flex flex-col p-0">
                        <div class="table-container flex-1 border-0 rounded-none">
                            <table id="table1">
                                <thead>
                                    <tr>
                                        <th style="width:40px">刪</th><th style="width:35px">序</th><th style="width:35px">月</th>
                                        <th style="width:90px">承辦單位</th><th style="width:180px">課程名稱</th><th style="width:80px">對象</th>
                                        <th style="width:130px">日期(點擊)</th><th style="width:110px">地點</th><th style="width:35px">梯</th>
                                        <th style="width:45px">梯人</th><th style="width:45px">總人</th>
                                        <th style="width:45px">日食</th><th style="width:45px">梯時</th><th style="width:45px">總時</th>
                                        <th style="width:90px" class="col-blue-light">調用人力</th>
                                        <th style="width:110px" class="col-yellow">宜基北桃</th>
                                        <th style="width:45px" class="col-yellow">新</th><th style="width:45px" class="col-yellow">基</th>
                                        <th style="width:45px" class="col-yellow">桃</th><th style="width:45px" class="col-yellow">宜</th>
                                        <th style="width:120px">備註</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody1"></tbody>
                            </table>
                        </div>
                        <div class="p-3 border-t border-slate-100 bg-slate-50 btn-action-area">
                            <button class="text-xs bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded hover:bg-slate-100 hover:text-blue-600 font-bold transition flex items-center gap-1 mx-auto shadow-sm" onclick="addRow(1)">
                                <i class="ri-add-line"></i> 新增一列
                            </button>
                        </div>
                    </div>

                    <!-- VIEW 2: 非消防人員 -->
                    <div id="view2" class="view-section hidden h-full flex flex-col p-0">
                        <div class="table-container flex-1 border-0 rounded-none">
                            <table id="table2">
                                <thead>
                                    <tr>
                                        <th style="width:40px">刪</th><th style="width:35px">序</th><th style="width:35px">月</th>
                                        <th style="width:90px">承辦單位</th><th style="width:180px">課程名稱</th><th style="width:100px">對象</th>
                                        <th style="width:130px">日期</th><th style="width:110px">地點</th><th style="width:35px">梯</th>
                                        <th style="width:45px">梯人</th><th style="width:45px">總人</th>
                                        <th style="width:45px">日時</th><th style="width:45px">梯時</th><th style="width:45px">總時</th>
                                        <th style="width:80px">本局教官</th>
                                        <th style="width:80px">跨縣市</th><th style="width:120px">備註</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody2"></tbody>
                            </table>
                        </div>
                        <div class="p-3 border-t border-slate-100 bg-slate-50 btn-action-area">
                            <button class="text-xs bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded hover:bg-slate-100 hover:text-blue-600 font-bold transition flex items-center gap-1 mx-auto shadow-sm" onclick="addRow(2)">
                                <i class="ri-add-line"></i> 新增一列
                            </button>
                        </div>
                    </div>

                    <!-- VIEW 3: 重大活動 -->
                    <div id="view3" class="view-section hidden h-full flex flex-col p-0">
                        <div class="table-container flex-1 border-0 rounded-none">
                            <table id="table3">
                                <thead>
                                    <tr>
                                        <th style="width:40px">刪</th><th style="width:35px">序</th>
                                        <th style="width:90px">承辦單位</th><th style="width:200px">活動名稱</th>
                                        <th style="width:120px">對象</th><th style="width:130px">日期</th>
                                        <th style="width:45px">天數</th><th style="width:45px">時數</th>
                                        <th style="width:90px" class="col-red-light">外勤人數</th>
                                        <th style="width:120px">地點</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody3"></tbody>
                            </table>
                        </div>
                        <div class="p-3 border-t border-slate-100 bg-slate-50 btn-action-area">
                            <button class="text-xs bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded hover:bg-slate-100 hover:text-blue-600 font-bold transition flex items-center gap-1 mx-auto shadow-sm" onclick="addRow(3)">
                                <i class="ri-add-line"></i> 新增一列
                            </button>
                        </div>
                    </div>

                    <!-- VIEW 4: 甘特圖 -->
                    <div id="view4" class="view-section hidden h-full flex flex-col p-0">
                        <div class="bg-amber-50 text-amber-800 px-4 py-2 text-xs border-b border-amber-100 flex items-center gap-2">
                            <i class="ri-error-warning-fill text-amber-500"></i>
                            <span>統計包含附件1~3所有人數。請使用上方按鈕下載 PDF/Excel。</span>
                        </div>
                        <div class="table-container flex-1 p-4 bg-white overflow-auto">
                            <div id="ganttExportArea">
                                <table id="table4">
                                    <tbody id="ganttContainer"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </main>

    <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="processCSV(this)">

    <script>
        const $ = (s) => document.querySelector(s);
        let d1 = [{ m: '1', unit: '', name: '', date: '', mp: 0, ex: [], isNew: true }];
        let d2 = [{ m: '1', unit: '', name: '', date: '', inst: 0, ex: [], isNew: true }];
        let d3 = [{ unit: '', name: '', date: '', mp: 0, ex: [], isNew: true }];
        let currentTab = 1; let printActionType = '';

        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('h-full');
        }

        window.onload = function () { updateToolbar(); loadData(); };

        function loadData() {
            if (GAS_API_URL.includes("請填入")) { renderAll(); return; }
            showLoading(true, "正在同步雲端資料...");
            fetch(GAS_API_URL).then(r => r.json()).then(res => {
                if (res.status === 'success') {
                    d1 = (res.d1 || []).map(r => ({ m: r[0], unit: r[1], name: r[2], target: r[3], date: r[4], loc: r[5], batch: r[6], pb: r[7], mp: r[12], ext: r[13] === 'true', nt: r[14], kl: r[15], ty: r[16], yl: r[17], note: r[18], ex: JSON.parse(r[19] || '[]'), isNew: false, dHour: r[9], bHour: r[10] }));
                    d2 = (res.d2 || []).map(r => ({ m: r[0], unit: r[1], name: r[2], target: r[3], date: r[4], loc: r[5], batch: r[6], pb: r[7], inst: r[12], ext: r[13] === 'true', note: r[14], ex: JSON.parse(r[15] || '[]'), isNew: false, dHour: r[9], bHour: r[10] }));
                    d3 = (res.d3 || []).map(r => ({ unit: r[0], name: r[1], target: r[2], date: r[3], days: r[4], hours: r[5], mp: r[6], loc: r[7], ex: JSON.parse(r[8] || '[]'), isNew: false }));
                    if (d1.length == 0) addRow(1); if (d2.length == 0) addRow(2); if (d3.length == 0) addRow(3);
                    renderAll();
                }
            }).catch(e => alert("連線錯誤: " + e)).finally(() => showLoading(false));
        }

        function saveData() {
            showLoading(true, "正在儲存至雲端...");
            const p1 = d1.map(r => [r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pb, (r.batch * r.pb) || 0, r.dHour, r.bHour, (r.batch * r.bHour) || 0, r.mp, r.ext, r.nt, r.kl, r.ty, r.yl, r.note, JSON.stringify(r.ex)]);
            const p2 = d2.map(r => [r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pb, (r.batch * r.pb) || 0, r.dHour, r.bHour, (r.batch * r.bHour) || 0, r.inst, r.ext, r.note, JSON.stringify(r.ex)]);
            const p3 = d3.map(r => [r.unit, r.name, r.target, r.date, r.days, r.hours, r.mp, r.loc, JSON.stringify(r.ex)]);
            fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ d1: p1, d2: p2, d3: p3 }), headers: { 'Content-Type': 'text/plain' } })
                .then(r => r.json()).then(res => { if (res.status === 'success') { alert(res.message);[d1, d2, d3].forEach(arr => arr.forEach(r => r.isNew = false)); renderAll(); } else alert("錯誤: " + res.message); })
                .finally(() => showLoading(false));
        }

        function switchTab(idx, el) {
            document.querySelectorAll('.sidebar-link').forEach(e => { e.classList.remove('active'); e.classList.add('text-slate-400'); });
            el.classList.remove('text-slate-400'); el.classList.add('active');
            
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(`view${idx}`).classList.remove('hidden');
            currentTab = idx;
            
            const titles = ["附件1 - 消防人員", "附件2 - 非消防人員", "附件3 - 重大活動", "甘特圖"];
            // document.getElementById('table-card-title').innerText = titles[idx - 1]; // Optional: change card title
            document.getElementById('mobilePageTitle').innerText = titles[idx - 1].replace(/附件\d - /, '');
            
            updateToolbar();
            if (idx === 4) renderGantt();
        }

        function updateToolbar() {
            const globalBar = document.getElementById('global-actions');
            const ganttBar = document.getElementById('gantt-actions');
            
            let globalHtml = '';
            let ganttHtml = '';
            
            const btnBase = "px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 transition whitespace-nowrap shadow-sm";
            const btnLight = `${btnBase} bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 hover:text-blue-600`;
            const btnPrimary = `${btnBase} bg-blue-600 text-white hover:bg-blue-700 border border-blue-600`;
            const btnGreen = `${btnBase} bg-emerald-600 text-white hover:bg-emerald-700`;
            const btnRed = `${btnBase} bg-rose-600 text-white hover:bg-rose-700`;

            // 全域功能區
            if (currentTab <= 3) {
                globalHtml += `<button class="${btnLight}" onclick="downloadCSVTemplate()"><i class="ri-file-download-line"></i> 範例</button>`;
                globalHtml += `<button class="${btnLight}" onclick="document.getElementById('csvInput').click()"><i class="ri-upload-cloud-line"></i> 匯入</button>`;
                globalHtml += `<button class="${btnPrimary}" onclick="saveData()"><i class="ri-save-3-line"></i> 儲存雲端</button>`;
                ganttBar.classList.add('hidden');
            } else {
                // 甘特圖時，隱藏全域的儲存，顯示下載
                globalHtml = '<span class="text-xs text-slate-400">檢視模式</span>';
                ganttHtml += `<button class="${btnGreen}" onclick="openPrintModal('excel')"><i class="ri-file-excel-2-line"></i> Excel</button>`;
                ganttHtml += `<button class="${btnRed}" onclick="openPrintModal('download')"><i class="ri-file-pdf-line"></i> PDF</button>`;
                ganttBar.innerHTML = ganttHtml;
                ganttBar.classList.remove('hidden');
            }
            globalBar.innerHTML = globalHtml;
        }

        function showLoading(s, t) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; if (t) document.getElementById('loadText').innerText = t; }
        function updateMonthFromDate(t, i, val) { let match = val.match(/^(\d+)\//); if (match) { let m = match[1]; if (t === 1) d1[i].m = m; if (t === 2) d2[i].m = m; document.getElementById(`m_${t}_${i}`).value = m; } if (t === 1) d1[i].date = val; if (t === 2) d2[i].date = val; if (t === 3) d3[i].date = val; }

        function renderAll() { renderT1(); renderT2(); renderT3(); }

        // Render Functions with Compressed UI
        function renderT1() {
            const tb = document.getElementById('tbody1'); tb.innerHTML = '';
            d1.forEach((r, i) => {
                tb.innerHTML += `<tr>
                <td style="text-align:center"><button class="text-slate-300 hover:text-red-500 transition" onclick="delRow(1,${i})"><i class="ri-close-circle-fill text-lg"></i></button></td>
                <td><input type="text" value="${i + 1}" readonly style="color:#94a3b8"></td>
                <td><input type="text" id="m_1_${i}" value="${r.m || ''}" readonly style="background:#f8fafc;color:#64748b"></td>
                <td><input type="text" value="${r.unit || ''}" onchange="d1[${i}].unit=this.value"></td>
                <td class="align-left"><textarea onchange="d1[${i}].name=this.value">${r.name || ''}</textarea></td>
                <td><input type="text" value="${r.target || ''}" onchange="d1[${i}].target=this.value"></td>
                <td><div class="date-cell"><input type="text" value="${r.date || ''}" onchange="updateMonthFromDate(1,${i},this.value)" placeholder="1/6-19"><button class="btn-calendar" onclick="openDateModal(1,${i})"><i class="ri-calendar-line"></i></button></div></td>
                <td><input type="text" value="${r.loc || ''}" onchange="d1[${i}].loc=this.value"></td>
                <td><input type="number" value="${r.batch || ''}" onchange="d1[${i}].batch=this.value"></td>
                <td><input type="number" value="${r.pb || ''}" onchange="d1[${i}].pb=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:32px;color:#64748b">${(r.batch * r.pb) || 0}</td>
                <td><input type="number" value="${r.dHour || ''}" onchange="d1[${i}].dHour=this.value"></td>
                <td><input type="number" value="${r.bh || ''}" onchange="d1[${i}].bh=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:32px;color:#64748b">${(r.batch * r.bh) || 0}</td>
                <td class="col-blue-light"><input type="number" value="${r.mp || ''}" onchange="d1[${i}].mp=this.value"></td>
                <td style="text-align:center"><input type="checkbox" class="w-4 h-4 text-blue-600 rounded" ${r.ext ? 'checked' : ''} onchange="d1[${i}].ext=this.checked"></td>
                <td><input type="number" value="${r.nt || ''}" onchange="d1[${i}].nt=this.value"></td>
                <td><input type="number" value="${r.kl || ''}" onchange="d1[${i}].kl=this.value"></td>
                <td><input type="number" value="${r.ty || ''}" onchange="d1[${i}].ty=this.value"></td>
                <td><input type="number" value="${r.yl || ''}" onchange="d1[${i}].yl=this.value"></td>
                <td class="align-left"><input type="text" value="${r.note || ''}" onchange="d1[${i}].note=this.value"></td>
                </tr>`;
            });
        }
        function renderT2() {
            const tb = document.getElementById('tbody2'); tb.innerHTML = '';
            d2.forEach((r, i) => {
                tb.innerHTML += `<tr>
                <td style="text-align:center"><button class="text-slate-300 hover:text-red-500 transition" onclick="delRow(2,${i})"><i class="ri-close-circle-fill text-lg"></i></button></td>
                <td><input type="text" value="${i + 1}" readonly style="color:#94a3b8"></td>
                <td><input type="text" id="m_2_${i}" value="${r.m || ''}" readonly style="background:#f8fafc;color:#64748b"></td>
                <td><input type="text" value="${r.unit || ''}" onchange="d2[${i}].unit=this.value"></td>
                <td class="align-left"><textarea onchange="d2[${i}].name=this.value">${r.name || ''}</textarea></td>
                <td><input type="text" value="${r.target || ''}" onchange="d2[${i}].target=this.value"></td>
                <td><div class="date-cell"><input type="text" value="${r.date || ''}" onchange="updateMonthFromDate(2,${i},this.value)"><button class="btn-calendar" onclick="openDateModal(2,${i})"><i class="ri-calendar-line"></i></button></div></td>
                <td><input type="text" value="${r.loc || ''}" onchange="d2[${i}].loc=this.value"></td>
                <td><input type="number" value="${r.batch || ''}" onchange="d2[${i}].batch=this.value"></td>
                <td><input type="number" value="${r.pb || ''}" onchange="d2[${i}].pb=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:32px;color:#64748b">${(r.batch * r.pb) || 0}</td>
                <td><input type="number" value="${r.dHour || ''}" onchange="d2[${i}].dHour=this.value"></td>
                <td><input type="number" value="${r.bHour || ''}" onchange="d2[${i}].bHour=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:32px;color:#64748b">${(r.batch * r.bHour) || 0}</td>
                <td><input type="number" value="${r.inst || ''}" onchange="d2[${i}].inst=this.value"></td>
                <td style="text-align:center"><input type="checkbox" class="w-4 h-4 text-blue-600 rounded" ${r.ext ? 'checked' : ''} onchange="d2[${i}].ext=this.checked"></td>
                <td class="align-left"><input type="text" value="${r.note || ''}" onchange="d2[${i}].note=this.value"></td>
                </tr>`;
            });
        }
        function renderT3() {
            const tb = document.getElementById('tbody3'); tb.innerHTML = '';
            d3.forEach((r, i) => {
                tb.innerHTML += `<tr>
                <td style="text-align:center"><button class="text-slate-300 hover:text-red-500 transition" onclick="delRow(3,${i})"><i class="ri-close-circle-fill text-lg"></i></button></td>
                <td><input type="text" value="${i + 1}" readonly style="color:#94a3b8"></td>
                <td><input type="text" value="${r.unit || ''}" onchange="d3[${i}].unit=this.value"></td>
                <td class="align-left"><textarea onchange="d3[${i}].name=this.value">${r.name || ''}</textarea></td>
                <td><input type="text" value="${r.target || ''}" onchange="d3[${i}].target=this.value"></td>
                <td><div class="date-cell"><input type="text" value="${r.date || ''}" onchange="updateMonthFromDate(3,${i},this.value)"><button class="btn-calendar" onclick="openDateModal(3,${i})"><i class="ri-calendar-line"></i></button></div></td>
                <td><input type="number" value="${r.days || ''}" onchange="d3[${i}].days=this.value"></td>
                <td><input type="number" value="${r.hours || ''}" onchange="d3[${i}].hours=this.value"></td>
                <td class="col-red-light"><input type="number" value="${r.mp || ''}" onchange="d3[${i}].mp=this.value"></td>
                <td class="align-left"><input type="text" value="${r.loc || ''}" onchange="d3[${i}].loc=this.value"></td>
                </tr>`;
            });
        }

        function delRow(t, i) {
            if (!confirm("確定刪除此列？")) return;
            if (t === 1) d1.splice(i, 1);
            if (t === 2) d2.splice(i, 1);
            if (t === 3) d3.splice(i, 1);
            renderAll();
        }

        function addRow(t) {
            if (t === 1) d1.push({ m: '', unit: '', name: '', isNew: true });
            if (t === 2) d2.push({ m: '', unit: '', name: '', isNew: true });
            if (t === 3) d3.push({ unit: '', name: '', isNew: true });
            renderAll();
        }

        function renderGantt() {
            const table = document.getElementById('table4');
            const container = document.getElementById('ganttContainer');
            
            let headerHTML = '<tr id="ganttHeader"><th class="col-fix-name">班期 / 活動名稱</th>';
            for (let i = 1; i <= 31; i++) headerHTML += `<th class="col-fix-day">${i}</th>`;
            headerHTML += '</tr>';

            table.innerHTML = `
                <colgroup>
                    <col style="width: 300px; min-width: 300px;">
                    ${Array(31).fill('<col style="width: 30px; min-width: 30px;">').join('')}
                </colgroup>
                <thead>${headerHTML}</thead>
                <tbody id="ganttContainer"></tbody>
            `;

            const newContainer = document.getElementById('ganttContainer');
            let rows = [];
            const parse = (r) => parseDateStr(r.date, r.ex);

            const add = (r, val, prefix) => {
                let daysSet = parse(r);
                let involvedMonths = [...new Set(daysSet.map(o => o.m))].sort((a, b) => a - b);
                involvedMonths.forEach(m => {
                    let daysInThisMonth = daysSet.filter(o => o.m === m).map(o => o.d);
                    let label = `${r.date} ${r.name} ${val > 0 ? `(${prefix} ${val}人)` : ''}`;
                    rows.push({ m: m, n: label, ds: daysInThisMonth, v: val });
                });
            };

            d1.forEach(r => { if (r.date && r.mp) add(r, r.mp, '調用'); });
            d2.forEach(r => { if (r.date && r.inst) add(r, r.inst, '教官'); });
            d3.forEach(r => { if (r.date && r.mp) add(r, r.mp, '調用'); });

            let grp = {}; for (let i = 1; i <= 12; i++) grp[i] = []; rows.forEach(r => { if (grp[r.m]) grp[r.m].push(r) });

            for (let m = 1; m <= 12; m++) {
                if (grp[m].length === 0) continue;
                
                let tbody = document.createElement('tbody');
                tbody.className = 'gantt-month-group';
                tbody.id = `month-${m}`;
                
                let html = `<tr class="gantt-month-header"><td colspan="32">${m} 月份</td></tr>`;
                let sum = Array(32).fill(0);

                grp[m].forEach(r => {
                    let row1 = `<tr class="gantt-visual-row"><td class="col-fix-name" rowspan="2">${r.n}</td>`;
                    let row2 = `<tr class="gantt-data-row">`;

                    for (let i = 1; i <= 31; i++) {
                        let act = r.ds.includes(i);
                        let w = new Date(2025, m - 1, i).getDay();
                        let wkCls = (w === 0 || w === 6) ? 'weekend' : '';
                        let val = parseInt(r.v); if (isNaN(val)) val = 0;
                        if (act) sum[i] += val;
                        let vShow = (act && r.v !== '' && r.v != null && (parseInt(r.v) > 0 || r.v == '0')) ? r.v : '';
                        row1 += `<td class="col-fix-day gantt-cell-bar ${wkCls} ${act ? 'bar-active' : ''}"></td>`;
                        row2 += `<td class="col-fix-day gantt-num ${wkCls}">${vShow}</td>`;
                    }
                    row1 += '</tr>'; row2 += '</tr>';
                    html += row1 + row2;
                });

                let sRow = `<tr class="stats-row"><td class="col-fix-name" style="text-align:center;">每日統計</td>`;
                for (let i = 1; i <= 31; i++) sRow += `<td class="col-fix-day">${sum[i]}</td>`;
                html += sRow + '</tr>';
                tbody.innerHTML = html;
                newContainer.appendChild(tbody);
            }
        }

        // --- Date Picker Logic ---
        let currentEdit = null;
        let selectedDates = new Set();
        let currentCalendarMonth = 1;

        function openDateModal(t, i) {
            currentEdit = { t, i };
            const val = t === 1 ? d1[i].date : t === 2 ? d2[i].date : d3[i].date;
            selectedDates.clear();
            const parsed = parseDateStr(val);
            parsed.forEach(o => selectedDates.add(`${o.m}-${o.d}`));
            if (parsed.length > 0) currentCalendarMonth = parsed[0].m;
            else currentCalendarMonth = 1;
            renderCalendar();
            document.getElementById('dateModal').classList.remove('hidden');
            document.getElementById('dateModal').classList.add('flex');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
            weekDays.forEach(d => grid.innerHTML += `<div class="text-center text-xs font-bold text-slate-500 py-1">${d}</div>`);
            const daysInMonth = new Date(2025, currentCalendarMonth, 0).getDate();
            const firstDay = new Date(2025, currentCalendarMonth - 1, 1).getDay();
            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
            for (let d = 1; d <= daysInMonth; d++) {
                const key = `${currentCalendarMonth}-${d}`;
                const isActive = selectedDates.has(key);
                const btn = document.createElement('div');
                btn.className = `day-btn ${isActive ? 'active' : ''}`;
                btn.innerText = d;
                btn.onclick = () => { if (selectedDates.has(key)) selectedDates.delete(key); else selectedDates.add(key); renderCalendar(); updateModalRangeText(); };
                grid.appendChild(btn);
            }
            const header = document.createElement('div');
            header.className = "col-span-7 flex justify-between items-center mb-2";
            header.innerHTML = `
                <button onclick="changeMonth(-1)" class="px-2 py-1 bg-slate-100 rounded hover:bg-slate-200"><i class="ri-arrow-left-s-line"></i></button>
                <span class="font-bold text-sm">${currentCalendarMonth} 月</span>
                <button onclick="changeMonth(1)" class="px-2 py-1 bg-slate-100 rounded hover:bg-slate-200"><i class="ri-arrow-right-s-line"></i></button>
            `;
            grid.insertBefore(header, grid.firstChild);
            updateModalRangeText();
        }

        function changeMonth(delta) {
            currentCalendarMonth += delta;
            if (currentCalendarMonth < 1) currentCalendarMonth = 12;
            if (currentCalendarMonth > 12) currentCalendarMonth = 1;
            renderCalendar();
        }

        function updateModalRangeText() {
            document.getElementById('modalRangeText').innerText = `已選取 ${selectedDates.size} 天`;
        }

        function applyDateFilter(type) {
            const daysInMonth = new Date(2025, currentCalendarMonth, 0).getDate();
            for (let d = 1; d <= daysInMonth; d++) {
                const key = `${currentCalendarMonth}-${d}`;
                const week = new Date(2025, currentCalendarMonth - 1, d).getDay();
                const isWeekend = (week === 0 || week === 6);
                if (type === 'all') selectedDates.add(key);
                else if (type === 'clear') selectedDates.delete(key);
                else if (type === 'no-weekend') { if (!isWeekend) selectedDates.add(key); else selectedDates.delete(key); }
                else if (type === 'only-weekend') { if (isWeekend) selectedDates.add(key); else selectedDates.delete(key); }
            }
            renderCalendar();
        }

        function saveDateModal() {
            if (!currentEdit) return;
            const sorted = [...selectedDates].map(s => {
                const [m, d] = s.split('-').map(Number);
                return { m, d, val: m * 100 + d };
            }).sort((a, b) => a.val - b.val);

            let str = "";
            if (sorted.length > 0) {
                let groups = {};
                sorted.forEach(o => { if (!groups[o.m]) groups[o.m] = []; groups[o.m].push(o.d); });
                let parts = [];
                for (let m in groups) {
                    let days = groups[m];
                    let ranges = [];
                    let start = days[0], prev = days[0];
                    for (let i = 1; i < days.length; i++) {
                        if (days[i] === prev + 1) prev = days[i];
                        else { ranges.push(start === prev ? `${start}` : `${start}-${prev}`); start = days[i]; prev = days[i]; }
                    }
                    ranges.push(start === prev ? `${start}` : `${start}-${prev}`);
                    parts.push(`${m}/${ranges.join('、')}`);
                }
                str = parts.join(', ');
            }
            const { t, i } = currentEdit;
            if (t === 1) d1[i].date = str;
            if (t === 2) d2[i].date = str;
            if (t === 3) d3[i].date = str;
            updateMonthFromDate(t, i, str);
            renderAll();
            closeModal('dateModal');
        }

        function openPrintModal(type) {
            printActionType = type;
            const grid = document.getElementById('printMonthGrid');
            grid.innerHTML = '';
            for (let i = 1; i <= 12; i++) { grid.innerHTML += `<div class="month-select-btn selected" onclick="this.classList.toggle('selected')" data-m="${i}">${i}月</div>`; }
            document.getElementById('printModal').classList.remove('hidden');
            document.getElementById('printModal').classList.add('flex');
        }

        function toggleAllMonths() {
            const btns = document.querySelectorAll('.month-select-btn');
            const allSelected = [...btns].every(b => b.classList.contains('selected'));
            btns.forEach(b => { if (allSelected) b.classList.remove('selected'); else b.classList.add('selected'); });
        }

        function executePrintOrExport() {
            const selected = [...document.querySelectorAll('.month-select-btn.selected')].map(b => parseInt(b.dataset.m));
            if (selected.length === 0) return alert("請至少選擇一個月份");
            closeModal('printModal');
            if (printActionType === 'excel') exportExcelJS(selected);
            else if (printActionType === 'download') downloadPDF(selected);
        }

        function parseDateStr(str, excludeList) {
            let results = [];
            if (!str) return results;
            try {
                let s = str.trim().replace(/[０-９]/g, d => "０１２３４５６７８９".indexOf(d)).replace(/（.*?）/g, '').replace(/\(.*?\)/g, '').replace(/／/g, '/').replace(/～/g, '-').replace(/~/g, '-').replace(/－/g, '-').trim();
                let parts = s.split(/[,、，\s]+/);
                parts.forEach(part => {
                    part = part.trim(); if (!part) return;
                    part = part.replace(/^(\d{2,4})\//, '');
                    let cross = part.match(/(\d+)[\/\.](\d+)\s*[-]\s*(\d+)[\/\.](\d+)/);
                    if (cross) {
                        let m1 = +cross[1], d1 = +cross[2], m2 = +cross[3], d2 = +cross[4];
                        let cur = new Date(2025, m1 - 1, d1), end = new Date(2025, m2 - 1, d2);
                        while (cur <= end) { results.push({ m: cur.getMonth() + 1, d: cur.getDate() }); cur.setDate(cur.getDate() + 1); }
                        return;
                    }
                    let rng = part.match(/(\d+)[\/\.](\d+)\s*[-]\s*(\d+)/);
                    if (rng) { let m = +rng[1], d1 = +rng[2], d2 = +rng[3]; for (let i = d1; i <= d2; i++) results.push({ m: m, d: i }); return; }
                    let sgl = part.match(/(\d+)[\/\.](\d+)/);
                    if (sgl) { results.push({ m: +sgl[1], d: +sgl[2] }); }
                });
                if (excludeList && excludeList.length > 0) results = results.filter(o => !excludeList.includes(o.d));
            } catch (e) { console.error("日期解析失敗:", e); }
            return results;
        }

        function downloadPDF(selectedMonths) {
            const element = document.getElementById('ganttExportArea');
            const container = document.querySelector('.table-container'); // Get the scrolling container
            const originalOverflow = container.style.overflow;
            
            if (selectedMonths) {
                for (let m = 1; m <= 12; m++) {
                    const tb = document.getElementById(`month-${m}`);
                    if (tb) { if (selectedMonths.includes(m)) tb.style.display = 'table-header-group'; else tb.style.display = 'none'; }
                }
            }

            container.style.overflow = 'visible'; // Force expand for capture
            
            const opt = {
                margin: 5, filename: '甘特圖報表.pdf', image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, scrollY: 0, useCORS: true, width: 1232 },
                jsPDF: { unit: 'pt', format: 'a3', orientation: 'landscape' }
            };
            showLoading(true, "正在產生 PDF...");
            html2pdf().set(opt).from(element).save().then(() => {
                container.style.overflow = originalOverflow; // Restore scroll
                for (let m = 1; m <= 12; m++) { let tb = document.getElementById(`month-${m}`); if (tb) tb.style.display = 'table-header-group'; }
                showLoading(false);
            });
        }

        async function exportExcelJS(selM) {
            const wb = new ExcelJS.Workbook(); const sh = wb.addWorksheet('甘特圖');
            sh.getColumn(1).width = 50; for (let k = 2; k <= 32; k++) sh.getColumn(k).width = 4;
            sh.addRow(["班期 / 活動名稱", ...Array.from({ length: 31 }, (_, k) => k + 1)]).eachCell(c => { c.font = { bold: true }; c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFf8fafc' } }; c.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } }; c.alignment = { horizontal: 'center' } });
            let rows = []; const parse = (r) => parseDateStr(r.date, r.ex);
            const add = (r, val, pre) => { let ds = parse(r), ms = [...new Set(ds.map(o => o.m))].sort((a, b) => a - b); ms.forEach(m => { rows.push({ m: m, n: `${r.date} ${r.name} ${val > 0 ? `(${pre}${val}人)` : ''}`, ds: ds.filter(o => o.m == m).map(o => o.d), v: val }); }); };
            d1.forEach(r => { if (r.date && r.mp) add(r, r.mp, '調用') }); d2.forEach(r => { if (r.date && r.inst) add(r, r.inst, '教官') }); d3.forEach(r => { if (r.date && r.mp) add(r, r.mp, '調用') });
            let grp = {}; for (let i = 1; i <= 12; i++) grp[i] = []; rows.forEach(r => { if (grp[r.m]) grp[r.m].push(r) });

            selM.forEach(m => {
                if (grp[m].length === 0) return;
                let mt = sh.addRow([`${m} 月份`]); mt.font = { bold: true, size: 12 }; mt.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFe2e8f0' } };
                let sum = Array(32).fill(0);
                grp[m].forEach(r => {
                    let dVis = [r.n], dDat = [""];
                    for (let i = 1; i <= 31; i++) {
                        if (r.ds.includes(i)) {
                            dVis.push("");
                            let vShow = ""; if (r.v !== '' && r.v != null && (parseInt(r.v) > 0 || r.v == '0' || r.v === 0)) { vShow = parseInt(r.v); }
                            dDat.push(vShow); sum[i] += parseInt(r.v) || 0;
                        } else { dVis.push(""); dDat.push(""); }
                    }
                    let rVis = sh.addRow(dVis); let rDat = sh.addRow(dDat);
                    rVis.eachCell((c, col) => { c.border = { right: { style: 'thin' } }; if (col === 1) c.alignment = { horizontal: 'left', vertical: 'middle', wrapText: true }; if (col > 1 && r.ds.includes(col - 1)) c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF3b82f6' } }; });
                    rDat.eachCell((c, col) => { c.border = { bottom: { style: 'thick' }, right: { style: 'thin' }, left: { style: 'thin' } }; c.alignment = { horizontal: 'center' }; if (col === 1) c.alignment = { horizontal: 'left', wrapText: true }; if (col > 1 && r.ds.includes(col - 1)) c.font = { bold: true }; });
                    sh.mergeCells(rVis.number, 1, rDat.number, 1);
                });
                let sd = ["每日統計"]; for (let i = 1; i <= 31; i++) sd.push(sum[i]);
                let sr = sh.addRow(sd);
                sr.eachCell((c) => { c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFf1f5f9' } }; c.font = { bold: true, color: { argb: 'FF1e40af' } }; c.border = { top: { style: 'double' }, bottom: { style: 'thick' }, left: { style: 'thin' }, right: { style: 'thin' } }; c.alignment = { horizontal: 'center' }; });
                sh.addRow([]);
            });
            const buf = await wb.xlsx.writeBuffer(); saveAs(new Blob([buf]), "甘特圖報表.xlsx");
        }
    </script>
</body>

</html>
