<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>臺北市政府消防局 114年教育訓練管理系統 (最終完美版)</title>
    <style>
        :root {
            --sidebar-bg: #020617;
            --sidebar-bg-soft: #020617;
            --active-item: #0f172a;
            --accent: #3b82f6;
            --accent-soft: #dbeafe;
            --bg-color: #e2e8f0;
            --border-color: #cbd5e1;
            --header-bg: #f8fafc;
            --shadow-soft: 0 18px 40px rgba(15,23,42,0.18);
            --radius-lg: 14px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: radial-gradient(circle at top left, #e0f2fe 0, #e2e8f0 35%, #cbd5e1 60%, #94a3b8 100%);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: #0f172a;
        }

        /* 整體框架：讓主介面像一張卡片浮在背景上 */
        body > .sidebar,
        body > .main-content {
            margin: 10px;
        }

        /* --- 側邊欄 --- */
        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #020617 0%, #020617 55%, #0b1120 100%);
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }
        .sidebar-header {
            padding: 18px 20px 16px;
            background: radial-gradient(circle at top left, #1d4ed8 0, #020617 55%);
            border-bottom: 1px solid #1e293b;
        }
        .sidebar-header h2 {
            margin: 0;
            font-size: 18px;
            letter-spacing: 1px;
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        .sidebar-header span {
            display: inline-block;
            margin-top: 6px;
        }

        nav {
            padding: 6px 8px 10px;
        }

        .nav-item {
            padding: 11px 14px;
            cursor: pointer;
            border-radius: 10px;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.18s ease-out;
            font-size: 13px;
            margin-bottom: 4px;
            position: relative;
        }
        .nav-item::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 999px;
            border: 1px solid transparent;
            background: transparent;
        }
        .nav-item:hover {
            background: rgba(148,163,184,0.10);
            color: #e5e7eb;
            transform: translateX(2px);
        }
        .nav-item.active {
            background: linear-gradient(135deg, rgba(37,99,235,0.06), rgba(15,23,42,0.85));
            color: #e5f0ff;
            font-weight: 600;
            box-shadow: 0 0 0 1px rgba(148,163,184,0.35), 0 14px 30px rgba(15,23,42,0.45);
        }
        .nav-item.active::before {
            border-color: #bfdbfe;
            background: #60a5fa;
        }

        /* --- 主內容區 --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: var(--radius-lg);
            background: rgba(248,250,252,0.96);
            box-shadow: var(--shadow-soft);
        }

        .top-bar {
            height: 60px;
            background: linear-gradient(90deg, #f9fafb 0%, #eff6ff 60%, #eef2ff 100%);
            border-bottom: 1px solid rgba(148,163,184,0.6);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 22px;
            position: relative;
            z-index: 3;
        }
        .page-title {
            font-size: 17px;
            font-weight: 600;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .page-title::before {
            content: '';
            width: 8px;
            height: 24px;
            border-radius: 999px;
            background: linear-gradient(180deg,#3b82f6,#1d4ed8);
        }

        .workspace {
            flex: 1;
            padding: 16px 16px 18px;
            overflow: hidden; /* 內部滾動 */
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at top, #f9fafb 0, #e5e7eb 55%, #e2e8f0 100%);
        }

        /* --- 視圖區塊 --- */
        .view-section {
            display: none;
            height: 100%;
            flex-direction: column;
            background: white;
            border-radius: 18px;
            box-shadow: 0 10px 25px rgba(15,23,42,0.12);
            overflow: hidden;
            border: 1px solid rgba(148,163,184,0.6);
        }
        .view-section.active { display: flex; }

        /* 區塊上面的細緻 header bar（列名區與內容分開一點） */
        .table-container {
            flex: 1;
            overflow: auto;
            background: linear-gradient(180deg,#f8fafc 0,#ffffff 50%,#f9fafb 100%);
        }

        /* --- 表格樣式 --- */
        table {
            border-collapse: collapse;
            font-size: 13px;
            table-layout: fixed;
            width: 100%;
        }

        #table1 { min-width: 2000px; }
        #table2 { min-width: 1800px; }
        #table3 { min-width: 1400px; }
        #table4 { min-width: 1600px; }

        thead tr {
            box-shadow: 0 1px 0 rgba(148,163,184,0.6);
        }

        th {
            background: linear-gradient(180deg, #f9fafb 0, #e5e7eb 100%);
            color: #475569;
            font-weight: 700;
            border: 1px solid #cbd5e1;
            text-align: center;
            vertical-align: middle;
            position: sticky;
            top: 0;
            z-index: 10;
            height: 48px;
            padding: 4px;
            font-size: 12px;
        }

        .th-content {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            line-height: 1.4;
            white-space: normal;
            padding: 0 4px;
        }

        tbody tr {
            transition: background 0.12s ease-out;
        }
        tbody tr:nth-child(even) td {
            background: #f9fafb;
        }
        tbody tr:hover td {
            background: #eff6ff;
        }

        td {
            border: 1px solid #e2e8f0;
            padding: 0;
            height: 34px;
            background: white;
            position: relative;
        }

        /* --- 輸入框 --- */
        input[type="text"], input[type="number"] {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            background: transparent;
            text-align: center;
            font-family: inherit;
            font-size: 13px;
            color: #0f172a;
        }
        input[readonly] {
            color: #9ca3af;
            background: #f3f4f6;
        }
        input::placeholder {
            color: #cbd5e1;
        }
        input:focus {
            background-color: #eff6ff;
            box-shadow: inset 0 0 0 1px var(--accent);
        }

        .align-left input {
            text-align: left;
            padding: 0 8px;
        }

        /* --- 日期與排除六日複合欄位 --- */
        .date-cell {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .date-cell input {
            flex: 1;
            border-bottom: 1px solid #e5e7eb;
        }
        .date-cell label {
            font-size: 10px;
            color: #64748b;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            height: 16px;
            border-top: 1px solid #e5e7eb;
        }
        .date-cell label:hover {
            background: #e2e8f0;
            color: #111827;
        }
        .date-cell input[type="checkbox"] {
            width: auto;
            height: auto;
            margin-right: 4px;
        }

        /* --- 仿 Excel 勾選框 --- */
        .td-checkbox {
            text-align: center !important;
            vertical-align: middle !important;
        }
        
        .excel-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 1px solid #4b5563;
            background-color: white;
            cursor: pointer;
            display: inline-block;
            position: relative;
            vertical-align: middle;
            margin: 0;
            transition: all 0.12s ease-out;
        }
        
        .excel-checkbox:checked {
            background: #1d4ed8;
            border-color: #1d4ed8;
            box-shadow: 0 0 0 1px #93c5fd;
        }
        .excel-checkbox:checked::after {
            content: '✓';
            font-size: 13px;
            font-weight: 800;
            color: #f9fafb;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -52%);
        }
        .excel-checkbox:hover {
            background-color: #e5e7eb;
        }

        /* --- 甘特圖樣式 --- */
        .gantt-header-month td {
            background: linear-gradient(90deg,#e2e8f0 0,#e5e7eb 40%,#e0f2fe 100%);
            font-weight: 700;
            text-align: left;
            padding-left: 18px;
            border-top: 2px solid #475569;
            border-bottom: 1px solid #94a3b8;
            color: #111827;
            font-size: 13px;
        }

        .gantt-visual-row {
            height: 14px;
        }
        .gantt-data-row {
            height: 30px;
        }

        .gantt-cell-bar {
            border-right: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        .bar-active {
            background: linear-gradient(180deg,#64748b,#4b5563);
            border-color: #374151;
        }

        .gantt-num input {
            font-weight: 600;
            color: #0f172a;
            font-size: 12px;
        }

        .stats-row td {
            background-color: #f1f5f9;
            border-top: 2px double #94a3b8;
            border-bottom: 2px solid #111827;
            color: #1d4ed8;
            font-weight: 700;
            font-size: 12px;
            text-align: center;
        }

        /* --- 按鈕與色彩 --- */
        .btn-action {
            padding: 7px 16px;
            border-radius: 999px;
            border: 0;
            color: white;
            font-size: 13px;
            cursor: pointer;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            letter-spacing: 0.4px;
            box-shadow: 0 8px 18px rgba(15,23,42,0.25);
            transition: all 0.15s ease-out;
            position: relative;
            overflow: hidden;
        }
        .btn-action::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top left, rgba(255,255,255,0.45), transparent 55%);
            opacity: 0;
            transition: opacity 0.15s ease-out;
        }
        .btn-action:hover::after {
            opacity: 1;
        }
        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 25px rgba(15,23,42,0.30);
        }
        .btn-action:active {
            transform: translateY(0);
            box-shadow: 0 6px 14px rgba(15,23,42,0.25);
        }

        .btn-add-row {
            width: 100%;
            padding: 10px;
            background: #f8fafc;
            border: 0;
            border-top: 1px solid #e2e8f0;
            color: #2563eb;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            letter-spacing: 0.4px;
            transition: all 0.15s ease-out;
        }
        .btn-add-row:hover {
            background: #e0f2fe;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);
        }

        .col-yellow {
            background: #fef9c3;
        }
        .col-blue-light {
            background: #e0f2fe;
        }
        .col-red-light {
            background: #fee2e2;
        }

        .text-manpower {
            color: #1d4ed8;
            font-weight: 600;
        }
        .text-danger {
            color: #b91c1c;
            font-weight: 600;
        }

        /* 刪除按鈕（「×」）微調 */
        td > button {
            font-size: 15px;
        }
        td > button:hover {
            background: #fee2e2 !important;
            color: #b91c1c !important;
        }

        /* 甘特圖說明列 */
        #view4 > div:first-child {
            border: 0;
            border-bottom: 1px solid #fed7aa;
        }

        /* 捲軸美化 */
        .table-container::-webkit-scrollbar {
            height: 10px;
            width: 10px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 999px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 999px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        /* 簡易 RWD：寬度太小時側邊欄高度縮放 */
        @media (max-width: 1200px) {
            body {
                font-size: 12px;
            }
            .sidebar {
                width: 220px;
            }
        }
        @media (max-width: 980px) {
            body {
                flex-direction: column;
            }
            body > .sidebar,
            body > .main-content {
                margin: 6px;
            }
            .sidebar {
                width: auto;
                flex-direction: row;
                overflow-x: auto;
                border-radius: 16px;
            }
            .sidebar-header {
                border-bottom: none;
                border-right: 1px solid #1e293b;
                min-width: 220px;
            }
            nav {
                display: flex;
                align-items: center;
                gap: 4px;
            }
            .nav-item {
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>

    <!-- 側邊欄 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>教育訓練管理系統</h2>
            <span style="font-size:11px; color:#e5e7eb">114年度版</span>
        </div>
        <nav>
            <div class="nav-item active" onclick="switchTab(1, this)">1. 消防人員訓練</div>
            <div class="nav-item" onclick="switchTab(2, this)">2. 非消防人員訓練</div>
            <div class="nav-item" onclick="switchTab(3, this)">3. 重大活動</div>
            <div class="nav-item" onclick="switchTab(4, this)">4. 甘特圖流路</div>
        </nav>
    </div>

    <!-- 主內容 -->
    <div class="main-content">
        <div class="top-bar">
            <div class="page-title" id="pageTitle">附件1 - 消防人員訓練</div>
            <div>
                <button class="btn-action" style="background:#16a34a" onclick="alert('模擬：Excel 報表生成中...')">下載 Excel</button>
                <button class="btn-action" style="background:#dc2626" onclick="alert('模擬：PDF 報表生成中...')">下載 PDF</button>
            </div>
        </div>

        <div class="workspace">
            
            <!-- TAB 1: 消防人員 -->
            <div id="view1" class="view-section active">
                <div class="table-container">
                    <table id="table1">
                        <thead>
                            <tr>
                                <th style="width:40px">刪</th>
                                <th style="width:40px">項次</th>
                                <th style="width:40px">月份</th>
                                <th style="width:100px">承辦單位</th>
                                <th style="width:200px">課程名稱</th>
                                <th style="width:80px">訓練對象</th>
                                <th style="width:140px">課程日期</th>
                                <th style="width:120px">上課地點</th>
                                <th style="width:40px">梯數</th>
                                <th style="width:50px">每梯<br>人數</th>
                                <th style="width:50px">合計<br>人數</th>
                                <th style="width:50px">每天<br>時數</th>
                                <th style="width:50px">每梯<br>時數</th>
                                <th style="width:50px">合計<br>時數</th>
                                <th style="width:100px" class="col-blue-light"><div class="th-content">預計調用人數<br>(分隊人力)</div></th>
                                <th style="width:120px" class="col-yellow"><div class="th-content">是否提供宜基<br>北桃參訓</div></th>
                                <th style="width:60px" class="col-yellow"><div class="th-content">暫訂<br>新北</div></th>
                                <th style="width:60px" class="col-yellow"><div class="th-content">暫訂<br>基隆</div></th>
                                <th style="width:60px" class="col-yellow"><div class="th-content">暫訂<br>桃園</div></th>
                                <th style="width:60px" class="col-yellow"><div class="th-content">暫訂<br>宜蘭</div></th>
                                <th style="width:150px">備註</th>
                            </tr>
                        </thead>
                        <tbody id="tbody1"></tbody>
                    </table>
                </div>
                <button class="btn-add-row" onclick="addRow(1)">+ 新增 消防人員課程</button>
            </div>

            <!-- TAB 2: 非消防人員 -->
            <div id="view2" class="view-section">
                <div class="table-container">
                    <table id="table2">
                        <thead>
                            <tr>
                                <th style="width:40px">刪</th>
                                <th style="width:40px">序號</th>
                                <th style="width:40px">月份</th>
                                <th style="width:100px">承辦單位</th>
                                <th style="width:200px">課程名稱</th>
                                <th style="width:120px">訓練對象</th>
                                <th style="width:140px">課程日期</th>
                                <th style="width:120px">訓練地點</th>
                                <th style="width:40px">梯數</th>
                                <th style="width:50px">每梯<br>人數</th>
                                <th style="width:50px">合計<br>人數</th>
                                <th style="width:50px">每天<br>時數</th>
                                <th style="width:50px">每梯<br>時數</th>
                                <th style="width:50px">合計<br>時數</th>
                                <th style="width:80px">調用本局<br>教官人數</th>
                                <th style="width:100px"><div class="th-content">是否提供<br>跨縣市</div></th>
                                <th style="width:150px">備註</th>
                            </tr>
                        </thead>
                        <tbody id="tbody2"></tbody>
                    </table>
                </div>
                <button class="btn-add-row" onclick="addRow(2)">+ 新增 非消防人員課程</button>
            </div>

            <!-- TAB 3: 重大活動 -->
            <div id="view3" class="view-section">
                <div class="table-container">
                    <table id="table3">
                        <thead>
                            <tr>
                                <th style="width:40px">刪</th>
                                <th style="width:40px">序號</th>
                                <th style="width:100px">承辦單位</th>
                                <th style="width:250px">重大活動演習名稱</th>
                                <th style="width:150px">參加對象</th>
                                <th style="width:140px">日期</th>
                                <th style="width:50px">天數</th>
                                <th style="width:50px">時數</th>
                                <th style="width:100px" class="col-red-light"><div class="th-content">每日調用<br>外勤人數</div></th>
                                <th style="width:150px">地點(教室)</th>
                            </tr>
                        </thead>
                        <tbody id="tbody3"></tbody>
                    </table>
                </div>
                <button class="btn-add-row" onclick="addRow(3)">+ 新增 重大活動</button>
            </div>

            <!-- TAB 4: 甘特圖 -->
            <div id="view4" class="view-section">
                <div style="padding:12px 16px; background:#fffbeb; border-bottom:1px solid #fbbf24; font-size:13px; color:#92400e;">
                    ⚠️ <strong>統計說明：</strong> 
                    統計範圍包含「附件1調用人數」+「附件2教官人數」+「附件3外勤人數」。
                    若在日期欄位勾選「排除六日」，甘特圖將自動跳過週六日不計入統計。
                </div>
                <div class="table-container">
                    <table id="table4">
                        <thead>
                            <tr id="ganttHeader">
                                <th style="width:250px">班期 / 活動名稱</th>
                                <!-- JS 將自動生成 1-31 的標題 -->
                            </tr>
                        </thead>
                        <tbody id="tbody4">
                            <!-- JS 生成甘特圖內容 -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 初始模擬資料 ---
        // 欄位: exclude 代表是否排除六日
        let d1 = [
            {m:'1', unit:'訓練中心', name:'火災搶救初級班', date:'1/6-19', mp:20, exclude:true, ext:false},
            {m:'1', unit:'訓練中心', name:'112年警特班', date:'1/10-24', mp:4, exclude:false, ext:false}
        ];
        let d2 = [
            {m:'1', unit:'應變科', name:'防災業務研習班', date:'1/13-15', inst:2, exclude:false, ext:false}
        ];
        let d3 = [
            {unit:'秘書室', name:'119消防節慶祝大會', date:'1/16', mp:25, exclude:false}
        ];

        // --- Tab 切換邏輯 ---
        function switchTab(idx, btn) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById(`view${idx}`).classList.add('active');
            
            const titles = ['附件1 - 消防人員訓練', '附件2 - 非消防人員訓練', '附件3 - 重大活動', '甘特圖 - 訓練流路'];
            document.getElementById('pageTitle').innerText = titles[idx-1];

            if(idx === 4) renderGantt();
        }

        // --- 渲染 Table 1 ---
        function renderT1() {
            const tb = document.getElementById('tbody1');
            tb.innerHTML = '';
            d1.forEach((r, i) => {
                tb.innerHTML += `<tr>
                    <td><button onclick="del(1,${i})" style="width:100%;color:#9ca3af;background:none;border:none;cursor:pointer;">×</button></td>
                    <td><input type="text" value="${i+1}" readonly></td>
                    <td><input type="text" value="${r.m||''}" onchange="d1[${i}].m=this.value"></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d1[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d1[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d1[${i}].target=this.value"></td>
                    <td>
                        <div class="date-cell">
                            <input type="text" value="${r.date||''}" onchange="d1[${i}].date=this.value" placeholder="1/6-19">
                            <label><input type="checkbox" ${r.exclude?'checked':''} onchange="d1[${i}].exclude=this.checked">排除六日</label>
                        </div>
                    </td>
                    <td><input type="text" value="${r.loc||''}" onchange="d1[${i}].loc=this.value"></td>
                    <td><input type="number" value="${r.batch||''}" onchange="d1[${i}].batch=this.value"></td>
                    <td><input type="number" value="${r.pBatch||''}" onchange="d1[${i}].pBatch=this.value"></td>
                    <td style="background:#f8fafc;text-align:center;line-height:36px;color:#64748b;">${(r.batch*r.pBatch)||0}</td>
                    <td><input type="number" value="${r.dHour||''}" onchange="d1[${i}].dHour=this.value"></td>
                    <td><input type="number" value="${r.bHour||''}" onchange="d1[${i}].bHour=this.value"></td>
                    <td style="background:#f8fafc;text-align:center;line-height:36px;color:#64748b;">${(r.batch*r.bHour)||0}</td>
                    <td class="col-blue-light"><input type="number" value="${r.mp||''}" onchange="d1[${i}].mp=this.value" class="text-manpower"></td>
                    
                    <td class="td-checkbox"><input type="checkbox" class="excel-checkbox" ${r.ext?'checked':''} onchange="d1[${i}].ext=this.checked"></td>
                    
                    <td><input type="number" value="${r.nt||''}" onchange="d1[${i}].nt=this.value"></td>
                    <td><input type="number" value="${r.kl||''}" onchange="d1[${i}].kl=this.value"></td>
                    <td><input type="number" value="${r.ty||''}" onchange="d1[${i}].ty=this.value"></td>
                    <td><input type="number" value="${r.yl||''}" onchange="d1[${i}].yl=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.note||''}" onchange="d1[${i}].note=this.value"></td>
                </tr>`;
            });
        }

        // --- 渲染 Table 2 ---
        function renderT2() {
            const tb = document.getElementById('tbody2');
            tb.innerHTML = '';
            d2.forEach((r, i) => {
                tb.innerHTML += `<tr>
                    <td><button onclick="del(2,${i})" style="width:100%;color:#9ca3af;background:none;border:none;cursor:pointer;">×</button></td>
                    <td><input type="text" value="${i+1}" readonly></td>
                    <td><input type="text" value="${r.m||''}" onchange="d2[${i}].m=this.value"></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d2[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d2[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d2[${i}].target=this.value"></td>
                    <td>
                        <div class="date-cell">
                            <input type="text" value="${r.date||''}" onchange="d2[${i}].date=this.value">
                            <label><input type="checkbox" ${r.exclude?'checked':''} onchange="d2[${i}].exclude=this.checked">排除六日</label>
                        </div>
                    </td>
                    <td><input type="text" value="${r.loc||''}" onchange="d2[${i}].loc=this.value"></td>
                    <td><input type="number" value="${r.batch||''}" onchange="d2[${i}].batch=this.value"></td>
                    <td><input type="number" value="${r.pBatch||''}" onchange="d2[${i}].pBatch=this.value"></td>
                    <td style="background:#f8fafc;text-align:center;line-height:36px;color:#64748b;">${(r.batch*r.pBatch)||0}</td>
                    <td><input type="number" value="${r.dHour||''}" onchange="d2[${i}].dHour=this.value"></td>
                    <td><input type="number" value="${r.bHour||''}" onchange="d2[${i}].bHour=this.value"></td>
                    <td style="background:#f8fafc;text-align:center;line-height:36px;color:#64748b;">${(r.batch*r.bHour)||0}</td>
                    <td><input type="number" value="${r.inst||''}" onchange="d2[${i}].inst=this.value"></td>
                    <td class="td-checkbox"><input type="checkbox" class="excel-checkbox" ${r.ext?'checked':''} onchange="d2[${i}].ext=this.checked"></td>
                    <td class="align-left"><input type="text" value="${r.note||''}" onchange="d2[${i}].note=this.value"></td>
                </tr>`;
            });
        }

        // --- 渲染 Table 3 ---
        function renderT3() {
            const tb = document.getElementById('tbody3');
            tb.innerHTML = '';
            d3.forEach((r, i) => {
                tb.innerHTML += `<tr>
                    <td><button onclick="del(3,${i})" style="width:100%;color:#9ca3af;background:none;border:none;cursor:pointer;">×</button></td>
                    <td><input type="text" value="${i+1}" readonly></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d3[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d3[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d3[${i}].target=this.value"></td>
                    <td>
                        <div class="date-cell">
                            <input type="text" value="${r.date||''}" onchange="d3[${i}].date=this.value" placeholder="1/16">
                            <label><input type="checkbox" ${r.exclude?'checked':''} onchange="d3[${i}].exclude=this.checked">排除六日</label>
                        </div>
                    </td>
                    <td><input type="number" value="${r.days||''}" onchange="d3[${i}].days=this.value"></td>
                    <td><input type="number" value="${r.hours||''}" onchange="d3[${i}].hours=this.value"></td>
                    <td class="col-red-light"><input type="number" value="${r.mp||''}" onchange="d3[${i}].mp=this.value" class="text-danger"></td>
                    <td class="align-left"><input type="text" value="${r.loc||''}" onchange="d3[${i}].loc=this.value"></td>
                </tr>`;
            });
        }

        // --- 甘特圖 (依月分組 + 獨立統計 + 排除六日) ---
        function renderGantt() {
            const header = document.getElementById('ganttHeader');
            header.innerHTML = '<th style="width:250px">班期 / 活動名稱</th>';
            for(let i=1; i<=31; i++) header.innerHTML += `<th style="width:30px; font-size:11px; color:#64748b;">${i}</th>`;

            const tbody = document.getElementById('tbody4');
            tbody.innerHTML = '';

            // 1. 解析函數：支援 2025 年六日排除
            const parse = (str, month, exclude) => {
                let days = [];
                if(!str) return days;
                try {
                    let s = str.replace(/\(.*\)/g, '').trim();
                    let rng = s.match(/(\d+)\/(\d+)-(\d+)/);
                    let sgl = s.match(/(\d+)\/(\d+)/);
                    let candidates = [];
                    if(rng) {
                         for(let i=+rng[2]; i<=+rng[3]; i++) candidates.push(i);
                    } else if(sgl) {
                        candidates.push(+sgl[2]);
                    } else if(s.includes(',')) {
                        s.split(',').forEach(p => {
                            let m = p.match(/\d+$/);
                            if(m) candidates.push(+m[0]);
                        });
                    }

                    candidates.forEach(day => {
                        if(exclude) {
                            let dt = new Date(2025, month-1, day);
                            let wd = dt.getDay();
                            if(wd !== 0 && wd !== 6) days.push(day);
                        } else {
                            days.push(day);
                        }
                    });

                } catch(e){}
                return days;
            };

            // 2. 資料收集
            let allRows = [];
            d1.forEach(r => { if(r.date && r.mp) allRows.push({m:r.m||'1', n:r.name, ds:parse(r.date, r.m||1, r.exclude), v:r.mp}); });
            d2.forEach(r => { if(r.date && r.inst) allRows.push({m:r.m||'1', n:r.name, ds:parse(r.date, r.m||1, r.exclude), v:r.inst}); });
            d3.forEach(r => { 
                if(r.date && r.mp) {
                    let mMatch = r.date.match(/^(\d+)/);
                    let m = mMatch ? mMatch[1] : '1';
                    allRows.push({m:m, n:r.name, ds:parse(r.date, m, r.exclude), v:r.mp}); 
                }
            });

            // 3. 按月份分組
            let grouped = {};
            for(let i=1; i<=12; i++) grouped[i] = [];
            allRows.forEach(r => { if(grouped[r.m]) grouped[r.m].push(r); });

            // 4. 渲染迴圈
            for(let m=1; m<=12; m++) {
                if(grouped[m].length === 0) continue;

                tbody.innerHTML += `<tr class="gantt-header-month"><td colspan="32">${m} 月份</td></tr>`;

                let monthlySum = Array(32).fill(0);

                grouped[m].forEach(r => {
                    let trVisual = `<tr class="gantt-visual-row">
                        <td style="border-right:1px solid #cbd5e1; border-bottom:none;"></td>`; 
                    
                    let trData = `<tr class="gantt-data-row">
                        <td class="align-left" style="padding-left:10px; font-size:12px; border-top:none;">${r.n}</td>`;

                    for(let i=1; i<=31; i++) {
                        let active = r.ds.includes(i);
                        if(active) monthlySum[i] += parseInt(r.v);

                        trVisual += `<td class="gantt-cell-bar ${active?'bar-active':''}"></td>`;
                        trData += `<td class="gantt-num">${active ? `<input type="text" value="${r.v}" readonly>` : ''}</td>`;
                    }
                    trVisual += '</tr>';
                    trData += '</tr>';
                    tbody.innerHTML += trVisual + trData;
                });

                let trStats = `<tr class="stats-row"><td>每日調用人數統計</td>`;
                for(let i=1; i<=31; i++) {
                    trStats += `<td>${monthlySum[i]>0 ? monthlySum[i] : ''}</td>`;
                }
                trStats += `</tr>`;
                tbody.innerHTML += trStats;
            }
        }

        // --- 通用操作 ---
        function addRow(t){if(t==1)d1.push({});if(t==2)d2.push({});if(t==3)d3.push({});renderAll();}
        function del(t,i){if(confirm('刪除此行?')){if(t==1)d1.splice(i,1);if(t==2)d2.splice(i,1);if(t==3)d3.splice(i,1);renderAll();}}
        function renderAll(){renderT1();renderT2();renderT3();}
        
        renderAll();

    </script>
</body>
</html>
