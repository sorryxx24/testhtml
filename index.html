<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>臺北市政府消防局 114年教育訓練管理系統 (雙列甘特圖版)</title>
    <style>
        :root {
            --primary-color: #1e40af;
            --secondary-color: #1e293b;
            --accent-color: #3b82f6;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --border-color: #cbd5e1;
            --text-main: #0f172a;
            --danger: #ef4444;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: var(--text-main);
        }

        /* 側邊欄 */
        .sidebar {
            width: 240px;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #334155; }
        .sidebar-header h2 { margin: 0; font-size: 18px; }
        .nav-item { padding: 15px 20px; cursor: pointer; border-left: 4px solid transparent; color: #94a3b8; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background-color: #334155; color: white; }
        .nav-item.active { background-color: #0f172a; color: var(--accent-color); border-left-color: var(--accent-color); font-weight: bold; }

        /* 主內容 */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 50px; background: white; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .workspace { flex: 1; padding: 15px; overflow: hidden; display: flex; flex-direction: column; }
        
        /* 卡片與表格容器 */
        .view-section { display: none; height: 100%; flex-direction: column; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid var(--border-color); overflow: hidden; }
        .view-section.active { display: flex; }
        
        .table-container { 
            flex: 1; 
            overflow: auto; 
            position: relative; 
        }

        /* 通用表格樣式 */
        table { 
            border-collapse: collapse; 
            font-size: 13px; 
            table-layout: fixed; /* 關鍵：固定表格布局 */
        }
        
        /* 附件表格寬度設定 (確保欄位不跑版) */
        #table1 { min-width: 1800px; }
        #table2 { min-width: 1600px; }
        #table3 { min-width: 1200px; }
        #table4 { min-width: 1400px; }

        th {
            background-color: #f1f5f9;
            color: #334155;
            font-weight: 700;
            padding: 8px 5px;
            border: 1px solid var(--border-color);
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            height: 40px;
        }

        td {
            border: 1px solid var(--border-color);
            padding: 0;
            height: 35px;
            position: relative;
        }

        /* 輸入框統一設定 */
        input[type="text"], input[type="number"] {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            padding: 0 5px;
            background: transparent;
            text-align: center; /* 預設置中 */
            font-family: inherit;
            font-size: 13px;
            box-sizing: border-box;
        }
        input:focus { background-color: #eff6ff; box-shadow: inset 0 0 0 2px var(--accent-color); }
        
        /* 針對特定靠左欄位的修正 */
        td.align-left input { text-align: left; padding-left: 8px; }

        /* 特別修正：是否提供宜基北桃參訓 (滿版) */
        .td-checkbox {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fff; 
        }
        .td-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin: 0;
        }

        /* 甘特圖專用樣式 (雙列模式) */
        .gantt-row-visual { height: 15px; } /* 上列：視覺條高度 */
        .gantt-row-data { height: 30px; }   /* 下列：數據格高度 */
        
        .gantt-bar { border-top: none; border-bottom: none; } /* 色塊格 */
        .gantt-num { background-color: white; } /* 數字格 */

        /* 視覺條顏色 */
        .bar-blue { background-color: #3b82f6; }   /* 附件1 */
        .bar-orange { background-color: #f97316; } /* 附件2 */
        .bar-red { background-color: #ef4444; }    /* 附件3 */

        /* 數據格文字 */
        .gantt-num input { font-weight: bold; color: #333; }
        
        /* 小計列 */
        .footer-row td { background-color: #1e293b; color: white; font-weight: bold; }
        .alert-red { background-color: #ef4444 !important; color: white; }

        /* 按鈕區 */
        .btn-area { padding: 10px; border-top: 1px solid var(--border-color); background: #f8fafc; }
        .btn-add { 
            width: 100%; padding: 10px; border: 1px dashed #cbd5e1; background: white; color: var(--accent-color); 
            font-weight: bold; cursor: pointer; 
        }
        .btn-add:hover { background: #eff6ff; border-color: var(--accent-color); }
        .btn-top { padding: 5px 15px; border-radius: 4px; border: none; cursor: pointer; font-size: 12px; color: white; margin-left: 5px; }
        
        /* 顏色標記類別 */
        .bg-yellow { background-color: #fefce8; }
        .bg-red-light { background-color: #fef2f2; }
        .text-manpower { color: #1d4ed8; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>消防訓練系統</h2>
            <p style="font-size:12px; color:#94a3b8;">114年版 v2.0</p>
        </div>
        <div class="nav-item active" onclick="switchTab(1, this)">1. 消防人員</div>
        <div class="nav-item" onclick="switchTab(2, this)">2. 非消防人員</div>
        <div class="nav-item" onclick="switchTab(3, this)">3. 重大活動</div>
        <div class="nav-item" onclick="switchTab(4, this)">4. 甘特圖流路</div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h3 id="pageTitle" style="margin:0; font-size:16px;">附件1 - 消防人員</h3>
            <div>
                <button class="btn-top" style="background:#16a34a" onclick="alert('Excel 下載功能需後端支援')">下載 Excel</button>
                <button class="btn-top" style="background:#dc2626" onclick="alert('PDF 下載功能需後端支援')">下載 PDF</button>
            </div>
        </div>

        <div class="workspace">
            
            <!-- TAB 1: 消防人員 -->
            <div id="view1" class="view-section active">
                <div class="table-container">
                    <table id="table1">
                        <thead>
                            <tr>
                                <th style="width:40px">刪</th>
                                <th style="width:40px">項次</th>
                                <th style="width:40px">月份</th>
                                <th style="width:100px">承辦單位</th>
                                <th style="width:200px">課程名稱</th>
                                <th style="width:80px">訓練對象</th>
                                <th style="width:120px">課程日期</th>
                                <th style="width:120px">上課地點</th>
                                <th style="width:40px">梯數</th>
                                <th style="width:50px">每梯<br>人數</th>
                                <th style="width:50px">合計<br>人數</th>
                                <th style="width:50px">每天<br>時數</th>
                                <th style="width:50px">每梯<br>時數</th>
                                <th style="width:50px">合計<br>時數</th>
                                <th style="width:100px" class="bg-yellow">預計調用<br>(分隊人力)</th>
                                <!-- 修正後的滿版 Checkbox 標題 -->
                                <th style="width:100px" class="bg-yellow">是否提供宜基<br>北桃參訓</th>
                                <th style="width:60px" class="bg-yellow">暫訂<br>新北</th>
                                <th style="width:60px" class="bg-yellow">暫訂<br>基隆</th>
                                <th style="width:60px" class="bg-yellow">暫訂<br>桃園</th>
                                <th style="width:60px" class="bg-yellow">暫訂<br>宜蘭</th>
                                <th style="width:150px">備註</th>
                            </tr>
                        </thead>
                        <tbody id="tbody1"></tbody>
                    </table>
                </div>
                <div class="btn-area"><button class="btn-add" onclick="addRow(1)">+ 新增課程</button></div>
            </div>

            <!-- TAB 2: 非消防人員 -->
            <div id="view2" class="view-section">
                <div class="table-container">
                    <table id="table2">
                        <thead>
                            <tr>
                                <th style="width:40px">刪</th>
                                <th style="width:40px">序號</th>
                                <th style="width:40px">月份</th>
                                <th style="width:100px">承辦單位</th>
                                <th style="width:200px">課程名稱</th>
                                <th style="width:120px">訓練對象</th>
                                <th style="width:120px">課程日期</th>
                                <th style="width:120px">訓練地點</th>
                                <th style="width:40px">梯數</th>
                                <th style="width:50px">每梯<br>人數</th>
                                <th style="width:50px">合計<br>人數</th>
                                <th style="width:50px">每天<br>時數</th>
                                <th style="width:50px">每梯<br>時數</th>
                                <th style="width:50px">合計<br>時數</th>
                                <th style="width:80px">調用本局<br>教官人數</th>
                                <th style="width:80px">是否提供<br>跨縣市</th>
                                <th style="width:150px">備註</th>
                            </tr>
                        </thead>
                        <tbody id="tbody2"></tbody>
                    </table>
                </div>
                <div class="btn-area"><button class="btn-add" onclick="addRow(2)">+ 新增課程</button></div>
            </div>

            <!-- TAB 3: 重大活動 -->
            <div id="view3" class="view-section">
                <div class="table-container">
                    <table id="table3">
                        <thead>
                            <tr>
                                <th style="width:40px">刪</th>
                                <th style="width:40px">序號</th>
                                <th style="width:100px">承辦單位</th>
                                <th style="width:250px">重大活動演習名稱</th>
                                <th style="width:150px">參加對象</th>
                                <th style="width:150px">日期</th>
                                <th style="width:50px">天數</th>
                                <th style="width:50px">時數</th>
                                <th style="width:100px" class="bg-red-light">每日調用<br>外勤人數</th>
                                <th style="width:150px">地點(教室)</th>
                            </tr>
                        </thead>
                        <tbody id="tbody3"></tbody>
                    </table>
                </div>
                <div class="btn-area"><button class="btn-add" onclick="addRow(3)">+ 新增活動</button></div>
            </div>

            <!-- TAB 4: 甘特圖 (雙列設計) -->
            <div id="view4" class="view-section">
                <div style="padding:10px; background:#fffbeb; font-size:12px; color:#92400e; border-bottom:1px solid #fbbf24;">
                    ⚠️ <strong>雙列顯示模式：</strong> 上列色塊代表活動區間（時間軸），下列顯示該日調用人數。
                    <span style="display:inline-block; width:10px; height:10px; background:#3b82f6; margin-left:10px;"></span> 消防
                    <span style="display:inline-block; width:10px; height:10px; background:#f97316; margin-left:5px;"></span> 教官
                    <span style="display:inline-block; width:10px; height:10px; background:#ef4444; margin-left:5px;"></span> 重大活動
                </div>
                <div class="table-container">
                    <table id="table4">
                        <thead>
                            <tr id="ganttHeader">
                                <!-- JS 生成表頭 -->
                            </tr>
                        </thead>
                        <tbody id="tbody4">
                            <!-- JS 生成內容 -->
                        </tbody>
                        <tfoot id="tfoot4">
                            <!-- JS 生成小計 -->
                        </tfoot>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 初始數據 ---
        let d1 = [
            {m:'1', unit:'訓練中心', name:'火災搶救初級班', date:'1/6-19', mp:20, ext:false}
        ];
        let d2 = [
            {m:'1', unit:'應變科', name:'防災業務研習班', date:'1/13-15', inst:2, ext:false}
        ];
        let d3 = [
            {unit:'秘書室', name:'119消防節', date:'1/16', mp:25}
        ];

        // --- 切換頁籤 ---
        function switchTab(idx, btn) {
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            document.getElementById(`view${idx}`).classList.add('active');
            
            const titles = ['1. 消防人員訓練', '2. 非消防人員訓練', '3. 重大活動與演習', '4. 年度訓練流路甘特圖'];
            document.getElementById('pageTitle').innerText = titles[idx-1];

            if(idx===4) renderGantt();
        }

        // --- 渲染表格 1 ---
        function renderT1() {
            const tb = document.getElementById('tbody1');
            tb.innerHTML = '';
            d1.forEach((r,i) => {
                tb.innerHTML += `<tr>
                    <td><button onclick="del(1,${i})" style="width:100%; color:#cbd5e1; background:none; border:none; cursor:pointer;">×</button></td>
                    <td><input type="text" value="${i+1}" readonly></td>
                    <td><input type="text" value="${r.m||''}" onchange="d1[${i}].m=this.value"></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d1[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d1[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d1[${i}].target=this.value"></td>
                    <td><input type="text" value="${r.date||''}" onchange="d1[${i}].date=this.value" placeholder="1/6-19"></td>
                    <td><input type="text" value="${r.loc||''}" onchange="d1[${i}].loc=this.value"></td>
                    <td><input type="number" value="${r.batch||''}" onchange="d1[${i}].batch=this.value"></td>
                    <td><input type="number" value="${r.pBatch||''}" onchange="d1[${i}].pBatch=this.value"></td>
                    <td style="background:#f8fafc; text-align:center; line-height:35px; color:#64748b;">${(r.batch*r.pBatch)||0}</td>
                    <td><input type="number" value="${r.dHour||''}" onchange="d1[${i}].dHour=this.value"></td>
                    <td><input type="number" value="${r.bHour||''}" onchange="d1[${i}].bHour=this.value"></td>
                    <td style="background:#f8fafc; text-align:center; line-height:35px; color:#64748b;">${(r.batch*r.bHour)||0}</td>
                    <td><input type="number" value="${r.mp||''}" onchange="d1[${i}].mp=this.value" class="text-manpower"></td>
                    
                    <!-- 修正：滿版 Checkbox -->
                    <td class="td-checkbox"><input type="checkbox" ${r.ext?'checked':''} onchange="d1[${i}].ext=this.checked"></td>
                    
                    <td><input type="number" value="${r.nt||''}" onchange="d1[${i}].nt=this.value"></td>
                    <td><input type="number" value="${r.kl||''}" onchange="d1[${i}].kl=this.value"></td>
                    <td><input type="number" value="${r.ty||''}" onchange="d1[${i}].ty=this.value"></td>
                    <td><input type="number" value="${r.yl||''}" onchange="d1[${i}].yl=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.note||''}" onchange="d1[${i}].note=this.value"></td>
                </tr>`;
            });
        }

        // --- 渲染表格 2 ---
        function renderT2() {
            const tb = document.getElementById('tbody2');
            tb.innerHTML = '';
            d2.forEach((r,i) => {
                tb.innerHTML += `<tr>
                    <td><button onclick="del(2,${i})" style="width:100%; color:#cbd5e1; background:none; border:none; cursor:pointer;">×</button></td>
                    <td><input type="text" value="${i+1}" readonly></td>
                    <td><input type="text" value="${r.m||''}" onchange="d2[${i}].m=this.value"></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d2[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d2[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d2[${i}].target=this.value"></td>
                    <td><input type="text" value="${r.date||''}" onchange="d2[${i}].date=this.value"></td>
                    <td><input type="text" value="${r.loc||''}" onchange="d2[${i}].loc=this.value"></td>
                    <td><input type="number" value="${r.batch||''}" onchange="d2[${i}].batch=this.value"></td>
                    <td><input type="number" value="${r.pBatch||''}" onchange="d2[${i}].pBatch=this.value"></td>
                    <td style="background:#f8fafc; text-align:center; line-height:35px; color:#64748b;">${(r.batch*r.pBatch)||0}</td>
                    <td><input type="number" value="${r.dHour||''}" onchange="d2[${i}].dHour=this.value"></td>
                    <td><input type="number" value="${r.bHour||''}" onchange="d2[${i}].bHour=this.value"></td>
                    <td style="background:#f8fafc; text-align:center; line-height:35px; color:#64748b;">${(r.batch*r.bHour)||0}</td>
                    <td><input type="number" value="${r.inst||''}" onchange="d2[${i}].inst=this.value"></td>
                    <td class="td-checkbox"><input type="checkbox" ${r.ext?'checked':''} onchange="d2[${i}].ext=this.checked"></td>
                    <td class="align-left"><input type="text" value="${r.note||''}" onchange="d2[${i}].note=this.value"></td>
                </tr>`;
            });
        }

        // --- 渲染表格 3 ---
        function renderT3() {
            const tb = document.getElementById('tbody3');
            tb.innerHTML = '';
            d3.forEach((r,i) => {
                tb.innerHTML += `<tr>
                    <td><button onclick="del(3,${i})" style="width:100%; color:#cbd5e1; background:none; border:none; cursor:pointer;">×</button></td>
                    <td><input type="text" value="${i+1}" readonly></td>
                    <td><input type="text" value="${r.unit||''}" onchange="d3[${i}].unit=this.value"></td>
                    <td class="align-left"><input type="text" value="${r.name||''}" onchange="d3[${i}].name=this.value"></td>
                    <td><input type="text" value="${r.target||''}" onchange="d3[${i}].target=this.value"></td>
                    <td><input type="text" value="${r.date||''}" onchange="d3[${i}].date=this.value" placeholder="1/16"></td>
                    <td><input type="number" value="${r.days||''}" onchange="d3[${i}].days=this.value"></td>
                    <td><input type="number" value="${r.hours||''}" onchange="d3[${i}].hours=this.value"></td>
                    <td><input type="number" value="${r.mp||''}" onchange="d3[${i}].mp=this.value" style="color:#ef4444; font-weight:bold;"></td>
                    <td class="align-left"><input type="text" value="${r.loc||''}" onchange="d3[${i}].loc=this.value"></td>
                </tr>`;
            });
        }

        // --- 甘特圖渲染 (雙列邏輯) ---
        function renderGantt() {
            const head = document.getElementById('ganttHeader');
            head.innerHTML = '<th style="width:50px">月</th><th style="width:200px">活動名稱</th>';
            for(let i=1;i<=31;i++) head.innerHTML += `<th style="width:30px">${i}</th>`;

            const tb = document.getElementById('tbody4');
            tb.innerHTML = '';
            let rows = [];

            // Helper: parse date
            const parse = (s) => {
                let d=[]; if(!s) return d;
                try {
                    let str=s.replace(/\(.*\)/,'').trim();
                    let rng=str.match(/(\d+)\/(\d+)-(\d+)/);
                    let sgl=str.match(/(\d+)\/(\d+)/);
                    if(rng) for(let i=+rng[2];i<=+rng[3];i++) d.push(i);
                    else if(sgl) d.push(+sgl[2]);
                }catch(e){}
                return d;
            };

            // Collect Data
            d1.forEach(r=>{ if(r.date && r.mp) rows.push({m:r.m||'1', n:r.name, ds:parse(r.date), v:r.mp, c:'bar-blue'}); });
            d2.forEach(r=>{ if(r.date && r.inst) rows.push({m:r.m||'1', n:r.name, ds:parse(r.date), v:r.inst, c:'bar-orange'}); });
            d3.forEach(r=>{ if(r.date && r.mp) rows.push({m:r.date.split('/')[0]||'1', n:r.name, ds:parse(r.date), v:r.mp, c:'bar-red'}); });

            rows.sort((a,b)=>+a.m - +b.m);

            rows.forEach((r, idx) => {
                // 上列：視覺色塊 (Row visual)
                let trVisual = `<tr>
                    <td rowspan="2" style="text-align:center; background:#f8fafc; font-weight:bold; border-bottom:2px solid #94a3b8;">${r.m}</td>
                    <td rowspan="2" style="font-size:12px; padding:0 5px; border-bottom:2px solid #94a3b8;" title="${r.n}">${r.n}</td>`;
                
                // 下列：數據填寫 (Row data)
                let trData = `<tr>`;

                for(let i=1; i<=31; i++) {
                    let active = r.ds.includes(i);
                    // Visual Cell
                    trVisual += `<td class="gantt-bar ${active ? r.c : ''}"></td>`;
                    // Data Cell
                    trData += `<td class="gantt-num" style="border-bottom:2px solid #94a3b8;">
                        ${active ? `<input type="text" value="${r.v}" readonly>` : ''}
                    </td>`;
                }
                trVisual += '</tr>';
                trData += '</tr>';
                tb.innerHTML += trVisual + trData;
            });

            // Footer Total
            const tf = document.getElementById('tfoot4');
            let sums = Array(32).fill(0);
            rows.forEach(r => {
                r.ds.forEach(d => { if(d<=31) sums[d] += +r.v; });
            });
            
            let ftHtml = `<tr class="footer-row"><td colspan="2" style="text-align:right; padding-right:10px;">每日缺口總計</td>`;
            for(let i=1; i<=31; i++) {
                let val = sums[i];
                let cls = val > 100 ? 'alert-red' : '';
                ftHtml += `<td class="${cls}" style="text-align:center; font-size:11px;">${val>0?val:''}</td>`;
            }
            ftHtml += '</tr>';
            tf.innerHTML = ftHtml;
        }

        // Ops
        function addRow(t) { if(t==1)d1.push({}); if(t==2)d2.push({}); if(t==3)d3.push({}); renderAll(); }
        function del(t,i) { if(confirm('刪除?')){ if(t==1)d1.splice(i,1); if(t==2)d2.splice(i,1); if(t==3)d3.splice(i,1); renderAll(); }}
        function renderAll() { renderT1(); renderT2(); renderT3(); }

        renderAll();
    </script>
</body>
</html>
