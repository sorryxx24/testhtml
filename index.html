<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ºåŒ—å¸‚æ”¿åºœæ¶ˆé˜²å±€ 114å¹´æ•™è‚²è¨“ç·´ç®¡ç†ç³»çµ± (å°ˆæ¥­ç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #1e40af; /* æ¶ˆé˜²è— */
            --secondary-color: #1e293b; /* æ·±ç° */
            --accent-color: #3b82f6; /* äº®è— */
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-main: #111827;
            --text-sub: #6b7280;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
        }

        body {
            font-family: 'Inter', 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: var(--text-main);
        }

        /* å´é‚Šå°è¦½åˆ— */
        .sidebar {
            width: 240px;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #334155;
            margin-bottom: 10px;
        }
        .sidebar-header h2 { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: 1px; }
        .sidebar-header p { margin: 5px 0 0; font-size: 12px; color: #94a3b8; }

        .nav-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            color: #cbd5e1;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover { background-color: #334155; color: white; }
        .nav-item.active { background-color: #334155; color: var(--accent-color); border-left-color: var(--accent-color); font-weight: 600; }

        /* ä¸»å…§å®¹å€ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            background-color: var(--card-bg);
            height: 60px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .action-buttons button {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.1s;
            margin-left: 8px;
        }
        .action-buttons button:active { transform: scale(0.98); }
        .btn-excel { background-color: var(--success); color: white; }
        .btn-pdf { background-color: var(--danger); color: white; }
        .btn-save { background-color: var(--primary-color); color: white; }

        /* è¡¨æ ¼å®¹å™¨ */
        .workspace {
            flex: 1;
            padding: 20px;
            overflow: auto;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden; /* for rounded corners */
            border: 1px solid var(--border-color);
        }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-container {
            width: 100%;
            overflow-x: auto;
            max-height: calc(100vh - 180px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1500px; /* ç¢ºä¿å¯¬åº¦è¶³å¤ ä¸æ“ å£“ */
            font-size: 13px;
        }

        th {
            background-color: #f8fafc;
            color: var(--secondary-color);
            font-weight: 600;
            text-align: left;
            padding: 12px 8px;
            border-bottom: 2px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
        }

        td {
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            padding: 0;
            height: 40px;
            position: relative;
        }

        tr:hover td { background-color: #f1f5f9; }

        /* è¼¸å…¥æ¡†æ¨£å¼ (Excel é¢¨æ ¼) */
        input[type="text"], input[type="number"], select {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            padding: 0 10px;
            background: transparent;
            font-family: inherit;
            font-size: 13px;
            color: var(--text-main);
        }
        input:focus {
            background-color: white;
            box-shadow: inset 0 0 0 2px var(--accent-color);
        }
        input::placeholder { color: #cbd5e1; font-style: italic; font-size: 12px; }
        
        /* ç‰¹æ®Šæ¬„ä½é¡è‰² */
        .col-yellow { background-color: #fef9c3; } /* é»ƒè‰²æ¨™é¡Œ */
        .col-read-only { background-color: #f3f4f6; color: #64748b; text-align: center; font-weight: bold; pointer-events: none; }
        .col-manpower { background-color: #eff6ff; font-weight: bold; color: var(--primary-color); }
        .col-danger { background-color: #fef2f2; font-weight: bold; color: var(--danger); }

        /* åˆªé™¤æŒ‰éˆ• */
        .btn-del {
            width: 100%; height: 100%; border: none; background: transparent; 
            color: #94a3b8; cursor: pointer; font-size: 14px; display: flex; 
            align-items: center; justify-content: center;
        }
        .btn-del:hover { color: var(--danger); background-color: #fee2e2; }

        /* æ–°å¢æŒ‰éˆ• */
        .btn-add-row {
            width: 100%;
            padding: 12px;
            border: none;
            background-color: #f8fafc;
            color: var(--accent-color);
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            border-top: 1px solid var(--border-color);
            transition: background 0.2s;
        }
        .btn-add-row:hover { background-color: #eff6ff; }

        /* ç”˜ç‰¹åœ–å°ˆç”¨æ¨£å¼ */
        .gantt-cell { text-align: center; font-size: 11px; padding: 0 !important; }
        .gantt-cell input { text-align: center; font-weight: bold; }
        
        /* è‡ªå‹•å¡«å…¥çš„è‰²å¡Š */
        .has-event-blue input { background-color: #bfdbfe; color: #1e3a8a; } /* é™„ä»¶1 */
        .has-event-orange input { background-color: #fed7aa; color: #9a3412; } /* é™„ä»¶2 */
        .has-event-red input { background-color: #fecaca; color: #991b1b; } /* é™„ä»¶3 */
        
        .alert-cell-red { background-color: #ef4444 !important; color: white !important; }
        
        /* éš±è—/é¡¯ç¤ºæ§åˆ¶ */
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Checkbox center */
        .check-center { display: flex; justify-content: center; align-items: center; height: 100%; }
    </style>
</head>
<body>

    <!-- å´é‚Šæ¬„ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>æ¶ˆé˜²è¨“ç·´ç®¡ç†</h2>
            <p>Training & Manpower System</p>
        </div>
        <nav>
            <div class="nav-item active" onclick="switchTab(1, this)">
                <span>ğŸ“„</span> é™„ä»¶1-æ¶ˆé˜²äººå“¡
            </div>
            <div class="nav-item" onclick="switchTab(2, this)">
                <span>ğŸ“„</span> é™„ä»¶2-éæ¶ˆé˜²äººå“¡
            </div>
            <div class="nav-item" onclick="switchTab(3, this)">
                <span>ğŸš¨</span> é™„ä»¶3-é‡å¤§æ´»å‹•
            </div>
            <div class="nav-item" onclick="switchTab(4, this)">
                <span>ğŸ“Š</span> ç”˜ç‰¹åœ–-è¨“ç·´æµè·¯
            </div>
        </nav>
    </div>

    <!-- ä¸»ä»‹é¢ -->
    <div class="main-content">
        <div class="top-bar">
            <div style="font-weight: 600; color: var(--secondary-color);" id="pageTitle">é™„ä»¶1 - æ¶ˆé˜²äººå“¡æ•™è‚²è¨“ç·´å¯¦é«”ç­æœŸ</div>
            <div class="action-buttons">
                <button class="btn-excel" onclick="alert('æ¨¡æ“¬ä¸‹è¼‰ï¼šæ ¼å¼èˆ‡å„é™„ä»¶å®Œå…¨ä¸€è‡´')">ğŸ“¥ ä¸‹è¼‰ Excel</button>
                <button class="btn-pdf" onclick="alert('æ¨¡æ“¬ä¸‹è¼‰ï¼šA3 æ©«å¼ PDF')">ğŸ“„ ä¸‹è¼‰ PDF</button>
                <button class="btn-save" onclick="saveData()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
            </div>
        </div>

        <div class="workspace">
            <!-- é™„ä»¶ 1 -->
            <div id="view1" class="view-section active card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:40px">åˆªé™¤</th>
                                <th style="width:50px">é …æ¬¡</th>
                                <th style="width:50px">æœˆä»½</th>
                                <th style="width:100px">æ‰¿è¾¦å–®ä½</th>
                                <th style="width:200px">èª²ç¨‹åç¨±</th>
                                <th style="width:100px">è¨“ç·´å°è±¡</th>
                                <th style="width:150px">èª²ç¨‹æ—¥æœŸ</th>
                                <th style="width:150px">ä¸Šèª²åœ°é»</th>
                                <th style="width:60px">æ¢¯æ•¸</th>
                                <th style="width:60px">æ¯æ¢¯äººæ•¸</th>
                                <th style="width:60px">åˆè¨ˆäººæ•¸</th>
                                <th style="width:60px">æ¯å¤©æ™‚æ•¸</th>
                                <th style="width:60px">æ¯æ¢¯æ™‚æ•¸</th>
                                <th style="width:60px">åˆè¨ˆæ™‚æ•¸</th>
                                <th style="width:120px" class="col-manpower">é è¨ˆèª¿ç”¨äººæ•¸<br>(åˆ†éšŠäººåŠ›)</th>
                                <th style="width:80px" class="col-yellow">æ˜¯å¦æä¾›å®œåŸº<br>åŒ—æ¡ƒåƒè¨“</th>
                                <th style="width:70px" class="col-yellow">æš«è¨‚<br>æ–°åŒ—(äºº)</th>
                                <th style="width:70px" class="col-yellow">æš«è¨‚<br>åŸºéš†(äºº)</th>
                                <th style="width:70px" class="col-yellow">æš«è¨‚<br>æ¡ƒåœ’(äºº)</th>
                                <th style="width:70px" class="col-yellow">æš«è¨‚<br>å®œè˜­(äºº)</th>
                                <th style="width:150px">å‚™è¨»</th>
                            </tr>
                        </thead>
                        <tbody id="tbody1">
                            <!-- JS æ¸²æŸ“ -->
                        </tbody>
                    </table>
                </div>
                <button class="btn-add-row" onclick="addRow(1)">+ æ–°å¢ æ¶ˆé˜²äººå“¡è¨“ç·´èª²ç¨‹</button>
            </div>

            <!-- é™„ä»¶ 2 -->
            <div id="view2" class="view-section card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:40px">åˆªé™¤</th>
                                <th style="width:50px">åºè™Ÿ</th>
                                <th style="width:50px">æœˆä»½</th>
                                <th style="width:100px">æ‰¿è¾¦å–®ä½</th>
                                <th style="width:200px">èª²ç¨‹åç¨±</th>
                                <th style="width:150px">è¨“ç·´å°è±¡</th>
                                <th style="width:150px">èª²ç¨‹æ—¥æœŸ</th>
                                <th style="width:150px">è¨“ç·´åœ°é»</th>
                                <th style="width:60px">æ¢¯æ•¸</th>
                                <th style="width:60px">æ¯æ¢¯äººæ•¸</th>
                                <th style="width:60px">åˆè¨ˆäººæ•¸</th>
                                <th style="width:60px">æ¯å¤©æ™‚æ•¸</th>
                                <th style="width:60px">æ¯æ¢¯æ™‚æ•¸</th>
                                <th style="width:60px">åˆè¨ˆæ™‚æ•¸</th>
                                <th style="width:100px">èª¿ç”¨æœ¬å±€<br>æ•™å®˜äººæ•¸</th>
                                <th style="width:80px">æ˜¯å¦æä¾›<br>è·¨ç¸£å¸‚</th>
                                <th style="width:200px">å‚™è¨»</th>
                            </tr>
                        </thead>
                        <tbody id="tbody2"></tbody>
                    </table>
                </div>
                <button class="btn-add-row" onclick="addRow(2)">+ æ–°å¢ éæ¶ˆé˜²äººå“¡/ç¾©æ¶ˆèª²ç¨‹</button>
            </div>

            <!-- é™„ä»¶ 3 -->
            <div id="view3" class="view-section card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:40px">åˆªé™¤</th>
                                <th style="width:50px">åºè™Ÿ</th>
                                <th style="width:100px">æ‰¿è¾¦å–®ä½</th>
                                <th style="width:250px">é‡å¤§æ´»å‹•æ¼”ç¿’åç¨±</th>
                                <th style="width:150px">åƒåŠ å°è±¡</th>
                                <th style="width:180px">æ—¥æœŸ</th>
                                <th style="width:60px">å¤©æ•¸</th>
                                <th style="width:60px">æ™‚æ•¸</th>
                                <th style="width:100px" class="col-danger">æ¯æ—¥èª¿ç”¨<br>å¤–å‹¤äººæ•¸</th>
                                <th style="width:200px">åœ°é»(æ•™å®¤)</th>
                            </tr>
                        </thead>
                        <tbody id="tbody3"></tbody>
                    </table>
                </div>
                <button class="btn-add-row" onclick="addRow(3)">+ æ–°å¢ é‡å¤§æ´»å‹•</button>
            </div>

            <!-- ç”˜ç‰¹åœ– -->
            <div id="view4" class="view-section card">
                <div style="padding: 15px; background-color: #fffbeb; border-bottom: 1px solid #fcd34d; color: #92400e; font-size: 13px; display: flex; align-items: center; gap: 10px;">
                    <span>ğŸ’¡ <strong>è‡ªå‹•é‹ç®—èªªæ˜ï¼š</strong> æ­¤è¡¨æœƒè®€å–å‰ä¸‰è¡¨çš„ã€Œæ—¥æœŸã€æ¬„ä½è‡ªå‹•å¡«å…¥ã€‚è‹¥æ—¥æœŸæ ¼å¼æ­£ç¢º (å¦‚ 1/6-19)ï¼Œå°‡è‡ªå‹•é¡¯ç¤ºè‰²å¡Šèˆ‡äººæ•¸ã€‚</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr id="ganttHeader">
                                <!-- JS ç”Ÿæˆè¡¨é ­ -->
                            </tr>
                        </thead>
                        <tbody id="tbody4"></tbody>
                        <tfoot id="tfoot4" style="position: sticky; bottom: 0; z-index: 20; background: white; box-shadow: 0 -2px 4px rgba(0,0,0,0.1);"></tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- åˆå§‹è³‡æ–™ ---
        let data1 = [
            { id:1, month:'1', unit:'è¨“ç·´ä¸­å¿ƒ', name:'ç«ç½æ¶æ•‘åˆç´šç­', target:'æ¶ˆé˜²äººå“¡', date:'1/6-19', location:'ç«¹å±±è¨“ç·´ä¸­å¿ƒ', batches:1, pBatch:20, dayHours:8, batchHours:80, manpower:20, ext:false, nt:0, kl:0, ty:0, yl:0, note:'' },
            { id:2, month:'1', unit:'è¨“ç·´ä¸­å¿ƒ', name:'è­¦ç‰¹éŒ„å–äººå“¡è¨“', target:'æ¶ˆé˜²äººå“¡', date:'1/10-1/24', location:'è¨“ç·´ä¸­å¿ƒ', batches:1, pBatch:4, dayHours:8, batchHours:120, manpower:4, ext:false, nt:0, kl:0, ty:0, yl:0, note:'' }
        ];
        let data2 = [
            { id:1, month:'1', unit:'æ‡‰è®Šç§‘', name:'é˜²ç½æ¥­å‹™ç ”ç¿’ç­', target:'å„æ©Ÿé—œäººå“¡', date:'1/13-1/15', location:'å…¬è¨“è™•', batches:3, pBatch:96, dayHours:6, batchHours:18, instructor:0, ext:false, note:'' }
        ];
        let data3 = [
            { id:1, unit:'ç§˜æ›¸å®¤', name:'119æ¶ˆé˜²ç¯€æ…¶ç¥å¤§æœƒ', target:'æˆçäººå“¡', date:'1/16', days:3, hours:3, manpower:25, location:'ä¸­æ²¹å¤§æ¨“' },
            { id:2, unit:'æ‡‰è®Šç§‘', name:'æ°‘å®‰11è™Ÿæ¼”ç¿’', target:'å¤–å‹¤å¤§éšŠ', date:'7/15(æš«å®š)', days:1, hours:24, manpower:400, location:'å¾…å®š' }
        ];

        let ganttData = [];

        // --- åˆ‡æ›åˆ†é  ---
        function switchTab(tabIndex, btn) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');

            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view${tabIndex}`).classList.add('active');

            const titles = ['é™„ä»¶1 - æ¶ˆé˜²äººå“¡æ•™è‚²è¨“ç·´å¯¦é«”ç­æœŸ', 'é™„ä»¶2 - éæ¶ˆé˜²äººå“¡æ•™è‚²è¨“ç·´å¯¦é«”ç­æœŸ', 'é™„ä»¶3 - é‡å¤§æ´»å‹•èˆ‡æ¼”ç¿’å½±éŸ¿é ä¼°', 'ç”˜ç‰¹åœ– - è¨“ç·´æµè·¯èˆ‡äººåŠ›é ä¼°'];
            document.getElementById('pageTitle').innerText = titles[tabIndex - 1];

            if(tabIndex === 4) calculateGantt();
        }

        // --- æ¸²æŸ“è¡¨æ ¼ 1 ---
        function renderTable1() {
            const tbody = document.getElementById('tbody1');
            tbody.innerHTML = '';
            data1.forEach((row, idx) => {
                const totalP = (row.batches||0) * (row.pBatch||0);
                const totalH = (row.batches||0) * (row.batchHours||0);
                tbody.innerHTML += `
                    <tr>
                        <td><button class="btn-del" onclick="delRow(1, ${idx})">âœ•</button></td>
                        <td><input type="text" value="${idx+1}" readonly style="text-align:center; color:#999"></td>
                        <td><input type="text" value="${row.month}" onchange="upd(1,${idx},'month',this.value)" placeholder="1"></td>
                        <td><input type="text" value="${row.unit}" onchange="upd(1,${idx},'unit',this.value)" placeholder="ç§‘å®¤"></td>
                        <td><input type="text" value="${row.name}" onchange="upd(1,${idx},'name',this.value)"></td>
                        <td><input type="text" value="${row.target}" onchange="upd(1,${idx},'target',this.value)"></td>
                        <td><input type="text" value="${row.date}" onchange="upd(1,${idx},'date',this.value)" placeholder="ä¾‹: 1/6-19"></td>
                        <td><input type="text" value="${row.location}" onchange="upd(1,${idx},'location',this.value)"></td>
                        <td><input type="number" value="${row.batches}" onchange="upd(1,${idx},'batches',this.value)"></td>
                        <td><input type="number" value="${row.pBatch}" onchange="upd(1,${idx},'pBatch',this.value)"></td>
                        <td class="col-read-only">${totalP}</td>
                        <td><input type="number" value="${row.dayHours}" onchange="upd(1,${idx},'dayHours',this.value)"></td>
                        <td><input type="number" value="${row.batchHours}" onchange="upd(1,${idx},'batchHours',this.value)"></td>
                        <td class="col-read-only">${totalH}</td>
                        <td class="col-manpower"><input type="number" value="${row.manpower}" onchange="upd(1,${idx},'manpower',this.value)" style="text-align:center; font-weight:bold; color:#1e40af"></td>
                        <td class="check-center"><input type="checkbox" ${row.ext?'checked':''} onchange="upd(1,${idx},'ext',this.checked)"></td>
                        <td><input type="number" value="${row.nt}" onchange="upd(1,${idx},'nt',this.value)"></td>
                        <td><input type="number" value="${row.kl}" onchange="upd(1,${idx},'kl',this.value)"></td>
                        <td><input type="number" value="${row.ty}" onchange="upd(1,${idx},'ty',this.value)"></td>
                        <td><input type="number" value="${row.yl}" onchange="upd(1,${idx},'yl',this.value)"></td>
                        <td><input type="text" value="${row.note}" onchange="upd(1,${idx},'note',this.value)"></td>
                    </tr>
                `;
            });
        }

        // --- æ¸²æŸ“è¡¨æ ¼ 2 ---
        function renderTable2() {
            const tbody = document.getElementById('tbody2');
            tbody.innerHTML = '';
            data2.forEach((row, idx) => {
                const totalP = (row.batches||0) * (row.pBatch||0);
                const totalH = (row.batches||0) * (row.batchHours||0);
                tbody.innerHTML += `
                    <tr>
                        <td><button class="btn-del" onclick="delRow(2, ${idx})">âœ•</button></td>
                        <td><input type="text" value="${idx+1}" readonly style="text-align:center; color:#999"></td>
                        <td><input type="text" value="${row.month}" onchange="upd(2,${idx},'month',this.value)"></td>
                        <td><input type="text" value="${row.unit}" onchange="upd(2,${idx},'unit',this.value)"></td>
                        <td><input type="text" value="${row.name}" onchange="upd(2,${idx},'name',this.value)"></td>
                        <td><input type="text" value="${row.target}" onchange="upd(2,${idx},'target',this.value)"></td>
                        <td><input type="text" value="${row.date}" onchange="upd(2,${idx},'date',this.value)" placeholder="ä¾‹: 1/13,14,15"></td>
                        <td><input type="text" value="${row.location}" onchange="upd(2,${idx},'location',this.value)"></td>
                        <td><input type="number" value="${row.batches}" onchange="upd(2,${idx},'batches',this.value)"></td>
                        <td><input type="number" value="${row.pBatch}" onchange="upd(2,${idx},'pBatch',this.value)"></td>
                        <td class="col-read-only">${totalP}</td>
                        <td><input type="number" value="${row.dayHours}" onchange="upd(2,${idx},'dayHours',this.value)"></td>
                        <td><input type="number" value="${row.batchHours}" onchange="upd(2,${idx},'batchHours',this.value)"></td>
                        <td class="col-read-only">${totalH}</td>
                        <td><input type="number" value="${row.instructor}" onchange="upd(2,${idx},'instructor',this.value)" style="text-align:center"></td>
                        <td class="check-center"><input type="checkbox" ${row.ext?'checked':''} onchange="upd(2,${idx},'ext',this.checked)"></td>
                        <td><input type="text" value="${row.note}" onchange="upd(2,${idx},'note',this.value)"></td>
                    </tr>
                `;
            });
        }

        // --- æ¸²æŸ“è¡¨æ ¼ 3 ---
        function renderTable3() {
            const tbody = document.getElementById('tbody3');
            tbody.innerHTML = '';
            data3.forEach((row, idx) => {
                tbody.innerHTML += `
                    <tr>
                        <td><button class="btn-del" onclick="delRow(3, ${idx})">âœ•</button></td>
                        <td><input type="text" value="${idx+1}" readonly style="text-align:center; color:#999"></td>
                        <td><input type="text" value="${row.unit}" onchange="upd(3,${idx},'unit',this.value)"></td>
                        <td><input type="text" value="${row.name}" onchange="upd(3,${idx},'name',this.value)"></td>
                        <td><input type="text" value="${row.target}" onchange="upd(3,${idx},'target',this.value)"></td>
                        <td><input type="text" value="${row.date}" onchange="upd(3,${idx},'date',this.value)" placeholder="ä¾‹: 1/16(æš«å®š)"></td>
                        <td><input type="number" value="${row.days}" onchange="upd(3,${idx},'days',this.value)"></td>
                        <td><input type="number" value="${row.hours}" onchange="upd(3,${idx},'hours',this.value)"></td>
                        <td class="col-danger"><input type="number" value="${row.manpower}" onchange="upd(3,${idx},'manpower',this.value)" style="color:#ef4444; font-weight:bold; text-align:center;"></td>
                        <td><input type="text" value="${row.location}" onchange="upd(3,${idx},'location',this.value)"></td>
                    </tr>
                `;
            });
        }

        // --- è³‡æ–™æ“ä½œ ---
        function upd(sheet, idx, field, val) {
            if(sheet===1) data1[idx][field] = val;
            if(sheet===2) data2[idx][field] = val;
            if(sheet===3) data3[idx][field] = val;
            if(sheet===1) renderTable1(); // Re-render for calcs
            if(sheet===2) renderTable2();
        }

        function addRow(sheet) {
            if(sheet===1) data1.push({ month:'', unit:'', name:'', date:'', manpower:0 });
            if(sheet===2) data2.push({ month:'', unit:'', name:'', date:'' });
            if(sheet===3) data3.push({ unit:'', name:'', date:'', manpower:0 });
            renderAll();
        }

        function delRow(sheet, idx) {
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤åˆ—ï¼Ÿ')) {
                if(sheet===1) data1.splice(idx,1);
                if(sheet===2) data2.splice(idx,1);
                if(sheet===3) data3.splice(idx,1);
                renderAll();
            }
        }

        function saveData() {
            console.log("Saved:", { data1, data2, data3 });
            alert("è³‡æ–™å·²æš«å­˜è‡³ç€è¦½å™¨è¨˜æ†¶é«”");
        }

        // --- ç”˜ç‰¹åœ–æ ¸å¿ƒï¼šæ—¥æœŸè§£æèˆ‡è‰²å¡Š ---
        function calculateGantt() {
            // è¡¨é ­
            const header = document.getElementById('ganttHeader');
            header.innerHTML = `<th style="width:50px">æœˆ</th><th style="width:250px">ç­æœŸ/æ´»å‹•åç¨±</th>`;
            for(let i=1; i<=31; i++) header.innerHTML += `<th style="width:25px; text-align:center; font-size:10px; color:#666;">${i}</th>`;

            // å½™æ•´
            ganttData = [];
            
            // Helper: Parse "1/6-19" or "1/13,14"
            const parse = (str) => {
                let days = [];
                if(!str) return days;
                try {
                    let s = str.replace(/\(.*\)/g, '').replace(/ï¼ˆ.*ï¼‰/g, '').trim();
                    // Range "1/6-19"
                    let range = s.match(/(\d+)\/(\d+)\s*-\s*(\d+)/);
                    if(range) {
                        for(let i=parseInt(range[2]); i<=parseInt(range[3]); i++) days.push(i);
                    } 
                    // Comma "1/13,14,15" or "1/13.14"
                    else if(s.includes(',') || s.includes('.')) {
                        let parts = s.split(/[,.]/);
                        parts.forEach(p => {
                            let d = parseInt(p.match(/\d+$/)); // grab last number segment
                            if(!isNaN(d)) days.push(d);
                        });
                    }
                    // Single "1/16"
                    else {
                        let single = s.match(/(\d+)\/(\d+)/);
                        if(single) days.push(parseInt(single[2]));
                    }
                } catch(e){}
                return days;
            };

            // Sheet 1 (Blue)
            data1.forEach(r => {
                if(r.date && r.manpower) {
                    let dArr = Array(31).fill('');
                    let pDays = parse(r.date);
                    pDays.forEach(d => { if(d<=31) dArr[d-1] = r.manpower; });
                    ganttData.push({ m: r.month||'1', name: r.name, days: dArr, type: 'has-event-blue' });
                }
            });
            // Sheet 2 (Orange - åªæœ‰ç•¶æœ‰å¯«æ•™å®˜äººæ•¸æ™‚æ‰åˆ—å…¥)
            data2.forEach(r => {
                if(r.date && r.instructor > 0) {
                    let dArr = Array(31).fill('');
                    parse(r.date).forEach(d => { if(d<=31) dArr[d-1] = r.instructor; });
                    ganttData.push({ m: r.month||'1', name: r.name + '(æ•™å®˜)', days: dArr, type: 'has-event-orange' });
                }
            });
            // Sheet 3 (Red)
            data3.forEach(r => {
                if(r.date && r.manpower) {
                    let dArr = Array(31).fill('');
                    parse(r.date).forEach(d => { if(d<=31) dArr[d-1] = r.manpower; });
                    let mMatch = r.date.match(/^(\d+)/);
                    ganttData.push({ m: mMatch?mMatch[1]:'1', name: `[é‡å¤§] ${r.name}`, days: dArr, type: 'has-event-red' });
                }
            });

            // Sort by month
            ganttData.sort((a,b) => parseInt(a.m) - parseInt(b.m));

            // Render Body
            const tbody = document.getElementById('tbody4');
            tbody.innerHTML = '';
            if(ganttData.length===0) tbody.innerHTML = `<tr><td colspan="33" style="text-align:center; padding:20px; color:#999;">å°šç„¡å¯è§£ææ—¥æœŸçš„è³‡æ–™</td></tr>`;
            
            ganttData.forEach((row, rIdx) => {
                let html = `<tr>
                    <td style="text-align:center; font-weight:bold; background:#f8fafc;">${row.m}</td>
                    <td style="font-size:12px; padding:0 5px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${row.name}">${row.name}</td>`;
                
                row.days.forEach((val, cIdx) => {
                    let cls = val ? row.type : '';
                    html += `<td class="gantt-cell ${cls}">
                        <input type="text" value="${val}" onchange="ganttData[${rIdx}].days[${cIdx}]=this.value; renderFooter();">
                    </td>`;
                });
                html += '</tr>';
                tbody.innerHTML += html;
            });
            renderFooter();
        }

        function renderFooter() {
            const tfoot = document.getElementById('tfoot4');
            let sums = Array(31).fill(0);
            ganttData.forEach(row => {
                row.days.forEach((v, i) => sums[i] += (parseInt(v)||0));
            });

            let html = `<tr><td colspan="2" style="text-align:right; padding-right:10px; font-weight:bold;">æ¯æ—¥äººåŠ›ç¼ºå£åˆè¨ˆ</td>`;
            sums.forEach(s => {
                let cls = s > 100 ? 'alert-cell-red' : '';
                html += `<td style="text-align:center; font-size:11px; font-weight:bold; ${s>0?'background:#f1f5f9':''}" class="${cls}">${s>0?s:''}</td>`;
            });
            html += '</tr>';
            tfoot.innerHTML = html;
        }

        function renderAll() {
            renderTable1();
            renderTable2();
            renderTable3();
        }

        // Init
        renderAll();

    </script>
</body>
</html>
